

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>podpac.core.algorithm.stats &mdash; 2.3.0</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/style.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
  
  
  
    <link rel="canonical" href="https://podpac.org_modules/podpac/core/algorithm/stats.html"/>
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/icon.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aws.html">AWS Integration</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../why-podpac.html">Why PODPAC?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nodes.html">Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../coordinates.html">Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cache.html">Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datasets.html">Supported Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interpolation.html">Interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../earthdata.html">NASA Earth Data Login</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aws-development.html">AWS Development</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wrapping-datasets.html">Wrapping Datasets</a></li>
</ul>
<p class="caption"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Development Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">PODPAC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>podpac.core.algorithm.stats</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for podpac.core.algorithm.stats</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Stats Summary</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">traitlets</span> <span class="k">as</span> <span class="nn">tl</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>

<span class="c1"># Internal dependencies</span>
<span class="kn">import</span> <span class="nn">podpac</span>
<span class="kn">from</span> <span class="nn">podpac.core.coordinates</span> <span class="kn">import</span> <span class="n">Coordinates</span>
<span class="kn">from</span> <span class="nn">podpac.core.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">podpac.core.algorithm.algorithm</span> <span class="kn">import</span> <span class="n">UnaryAlgorithm</span><span class="p">,</span> <span class="n">Algorithm</span>
<span class="kn">from</span> <span class="nn">podpac.core.utils</span> <span class="kn">import</span> <span class="n">common_doc</span><span class="p">,</span> <span class="n">NodeTrait</span>
<span class="kn">from</span> <span class="nn">podpac.core.node</span> <span class="kn">import</span> <span class="n">COMMON_NODE_DOC</span><span class="p">,</span> <span class="n">node_eval</span>

<span class="n">COMMON_DOC</span> <span class="o">=</span> <span class="n">COMMON_NODE_DOC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Set up logging</span>
<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Reduce</span><span class="p">(</span><span class="n">UnaryAlgorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base node for statistical algorithms</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    dims : list</span>
<span class="sd">        List of strings that give the dimensions which should be reduced</span>
<span class="sd">    source : podpac.Node</span>
<span class="sd">        The source node that will be reduced.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">List</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_reduced_coordinates</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">Coordinates</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_dims</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">trait</span><span class="o">=</span><span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_first_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;dims&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dims&quot;</span><span class="p">],</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dims&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dims&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Reduce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_first_init</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dims_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the indices for the dimensions that will be reduced. This is passed to numpy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output : UnitsDataArray</span>
<span class="sd">            The output array with the reduced dimensions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of integers for the dimensions that will be reduces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span> <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">axes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chunk_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Size of chunks for parallel processing or large arrays that do not fit in memory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Size of chunks</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">podpac</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;CHUNK_SIZE&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># TODO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chunk_size</span>

    <span class="k">def</span> <span class="nf">_get_chunk_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shape of chunks for parallel processing or large arrays that do not fit in memory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of integers giving the shape of each chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">coords</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">}</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">chunk_size</span> <span class="o">//</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            <span class="n">s</span> <span class="o">*=</span> <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transpose and reshape a DataArray to put the reduce dimensions together</span>
<span class="sd">        as axis 0. This is useful for example for scipy.stats.skew and kurtosis</span>
<span class="sd">        which only calculate over a single axis, by default 0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : xr.DataArray</span>
<span class="sd">            Input DataArray</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        a : np.array</span>
<span class="sd">            Transposed and reshaped array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">a</span>

    <span class="k">def</span> <span class="nf">iteroutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for the chunks of the output</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Output for this chunk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunk_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_chunk_shape</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">iterchunks</span><span class="p">(</span><span class="n">chunk_shape</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="nd">@common_doc</span><span class="p">(</span><span class="n">COMMON_DOC</span><span class="p">)</span>
    <span class="nd">@node_eval</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates this nodes using the supplied coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : podpac.Coordinates</span>
<span class="sd">            {requested_coordinates}</span>
<span class="sd">        output : podpac.UnitsDataArray, optional</span>
<span class="sd">            {eval_output}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        {eval_return}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_requested_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_output_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reduced_coordinates</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">&lt;</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteroutputs</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="n">output</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No reduce_chunked method defined, using one-step reduce&quot;</span><span class="p">)</span>
                <span class="n">source_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">source_output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">source_output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
            <span class="n">output</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce a full array, e.g. x.mean(dims).</span>

<span class="sd">        Must be defined in each child.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Array that needs to be reduced.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            Must be defined in each child.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce a list of xs with a memory-effecient iterative algorithm.</span>

<span class="sd">        Optionally defined in each child.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : list, generator</span>
<span class="sd">            List of UnitsDataArray&#39;s that need to be reduced together.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Reduced output.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">ReduceOrthogonal</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extended Reduce class that enables chunks that are smaller than the reduced</span>
<span class="sd">    output array.</span>

<span class="sd">    The base Reduce node ensures that each chunk is at least as big as the</span>
<span class="sd">    reduced output, which works for statistics that can be calculated in O(1)</span>
<span class="sd">    space. For statistics that require O(n) space, the node must iterate</span>
<span class="sd">    through the Coordinates orthogonally to the reduce dimension, using chunks</span>
<span class="sd">    that only cover a portion of the output array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_chunk_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shape of chunks for parallel processing or large arrays that do not fit in memory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of integers giving the shape of each chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>

        <span class="c1"># here, the minimum size is the reduce-dimensions size</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">coords</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">}</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">dims</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">chunk_size</span> <span class="o">//</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            <span class="n">s</span> <span class="o">*=</span> <span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">iteroutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for the chunks of the output</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Output for this chunk</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">chunk_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_chunk_shape</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">slices</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">iterchunks</span><span class="p">(</span><span class="n">chunk_shape</span><span class="p">,</span> <span class="n">return_slices</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">chunk</span><span class="p">),</span> <span class="n">slices</span>

    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce a list of xs with a memory-effecient iterative algorithm.</span>

<span class="sd">        Optionally defined in each child.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : list, generator</span>
<span class="sd">            List of UnitsDataArray&#39;s that need to be reduced together.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Reduced output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># special case for full reduce</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_coordinates</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">xslices</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">xslices</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">yslc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xslices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_requested_coordinates</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_coordinates</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">yslc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>


<div class="viewcode-block" id="Min"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Min.html#podpac.algorithm.Min">[docs]</a><span class="k">class</span> <span class="nc">Min</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the minimum across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Min.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Min.html#podpac.algorithm.Min.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the minimum across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Minimum of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="Min.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Min.html#podpac.algorithm.Min.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the minimum across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Minimum of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note: np.fmin ignores NaNs, np.minimum propagates NaNs</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">y</span></div></div>


<div class="viewcode-block" id="Max"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Max.html#podpac.algorithm.Max">[docs]</a><span class="k">class</span> <span class="nc">Max</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the maximum across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Max.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Max.html#podpac.algorithm.Max.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the maximum across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Maximum of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="Max.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Max.html#podpac.algorithm.Max.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the maximum across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Maximum of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note: np.fmax ignores NaNs, np.maximum propagates NaNs</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">y</span></div></div>


<div class="viewcode-block" id="Sum"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Sum.html#podpac.algorithm.Sum">[docs]</a><span class="k">class</span> <span class="nc">Sum</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the sum across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Sum.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Sum.html#podpac.algorithm.Sum.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the sum across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Sum of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="Sum.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Sum.html#podpac.algorithm.Sum.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the sum across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Sum of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div></div>


<div class="viewcode-block" id="Count"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Count.html#podpac.algorithm.Count">[docs]</a><span class="k">class</span> <span class="nc">Count</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Counts the finite values across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Count.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Count.html#podpac.algorithm.Count.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Counts the finite values across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Number of finite values of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="Count.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Count.html#podpac.algorithm.Count.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Counts the finite values across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Number of finite values of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span></div></div>


<div class="viewcode-block" id="Mean"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Mean.html#podpac.algorithm.Mean">[docs]</a><span class="k">class</span> <span class="nc">Mean</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the mean across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Mean.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Mean.html#podpac.algorithm.Mean.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the mean across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Mean of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mean.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Mean.html#podpac.algorithm.Mean.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the mean across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Mean of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="c1"># TODO efficency</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">output</span></div></div>


<div class="viewcode-block" id="Variance"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Variance.html#podpac.algorithm.Variance">[docs]</a><span class="k">class</span> <span class="nc">Variance</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the variance across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Variance.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Variance.html#podpac.algorithm.Variance.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the variance across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Variance of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variance.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Variance.html#podpac.algorithm.Variance.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the variance across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Variance of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="c1"># Welford, adapted to handle multiple data points in each iteration</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">m</span>
            <span class="n">m</span> <span class="o">+=</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">m</span>
            <span class="n">m2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m2</span> <span class="o">/</span> <span class="n">n</span></div></div>


<div class="viewcode-block" id="Skew"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Skew.html#podpac.algorithm.Skew">[docs]</a><span class="k">class</span> <span class="nc">Skew</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the skew across dimension(s)</span>

<span class="sd">    TODO NaN behavior when there is NO data (currently different in reduce and reduce_chunked)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Skew.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Skew.html#podpac.algorithm.Skew.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the skew across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Skew of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># N = np.isfinite(x).sum(dim=self._dims)</span>
        <span class="c1"># M1 = x.mean(dim=self._dims)</span>
        <span class="c1"># E = x - M1</span>
        <span class="c1"># E2 = E**2</span>
        <span class="c1"># E3 = E2*E</span>
        <span class="c1"># M2 = (E2).sum(dim=self._dims)</span>
        <span class="c1"># M3 = (E3).sum(dim=self._dims)</span>
        <span class="c1"># skew = self.skew(M3, M2, N)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reshape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">skew</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">skew</span></div>

<div class="viewcode-block" id="Skew.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Skew.html#podpac.algorithm.Skew.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the skew across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Skew of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">check_empty</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">Nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">M1x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">Ex</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">M1x</span>
            <span class="n">Ex2</span> <span class="o">=</span> <span class="n">Ex</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">Ex3</span> <span class="o">=</span> <span class="n">Ex2</span> <span class="o">*</span> <span class="n">Ex</span>
            <span class="n">M2x</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ex2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">M3x</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ex3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>

            <span class="c1"># premask to omit NaNs</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">Nx</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">Nx</span> <span class="o">=</span> <span class="n">Nx</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M1x</span> <span class="o">=</span> <span class="n">M1x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M2x</span> <span class="o">=</span> <span class="n">M2x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M3x</span> <span class="o">=</span> <span class="n">M3x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

            <span class="n">Nb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M1b</span> <span class="o">=</span> <span class="n">M1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M2b</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

            <span class="c1"># merge</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">M1x</span> <span class="o">-</span> <span class="n">M1b</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Nb</span> <span class="o">+</span> <span class="n">Nx</span>
            <span class="n">NNx</span> <span class="o">=</span> <span class="n">Nb</span> <span class="o">*</span> <span class="n">Nx</span>

            <span class="n">M3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">M3x</span> <span class="o">+</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">NNx</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">-</span> <span class="n">Nx</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">*</span> <span class="n">M2x</span> <span class="o">-</span> <span class="n">Nx</span> <span class="o">*</span> <span class="n">M2b</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">M2x</span> <span class="o">+</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">NNx</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">M1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">N</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="c1"># calculate skew</span>
        <span class="n">skew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">M3</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M2</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">skew</span></div></div>


<div class="viewcode-block" id="Kurtosis"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Kurtosis.html#podpac.algorithm.Kurtosis">[docs]</a><span class="k">class</span> <span class="nc">Kurtosis</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the kurtosis across dimension(s)</span>

<span class="sd">    TODO NaN behavior when there is NO data (currently different in reduce and reduce_chunked)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Kurtosis.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Kurtosis.html#podpac.algorithm.Kurtosis.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the kurtosis across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Kurtosis of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># N = np.isfinite(x).sum(dim=self._dims)</span>
        <span class="c1"># M1 = x.mean(dim=self._dims)</span>
        <span class="c1"># E = x - M1</span>
        <span class="c1"># E2 = E**2</span>
        <span class="c1"># E4 = E2**2</span>
        <span class="c1"># M2 = (E2).sum(dim=self._dims)</span>
        <span class="c1"># M4 = (E4).sum(dim=self._dims)</span>
        <span class="c1"># kurtosis = N * M4 / M2**2 - 3</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reshape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kurtosis</span></div>

<div class="viewcode-block" id="Kurtosis.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Kurtosis.html#podpac.algorithm.Kurtosis.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the kurtosis across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Kurtosis of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">M4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">Nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">M1x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">Ex</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">M1x</span>
            <span class="n">Ex2</span> <span class="o">=</span> <span class="n">Ex</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">Ex3</span> <span class="o">=</span> <span class="n">Ex2</span> <span class="o">*</span> <span class="n">Ex</span>
            <span class="n">Ex4</span> <span class="o">=</span> <span class="n">Ex2</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">M2x</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ex2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">M3x</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ex3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>
            <span class="n">M4x</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ex4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>

            <span class="c1"># premask to omit NaNs</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">Nx</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">Nx</span> <span class="o">=</span> <span class="n">Nx</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M1x</span> <span class="o">=</span> <span class="n">M1x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M2x</span> <span class="o">=</span> <span class="n">M2x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M3x</span> <span class="o">=</span> <span class="n">M3x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M4x</span> <span class="o">=</span> <span class="n">M4x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

            <span class="n">Nb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M1b</span> <span class="o">=</span> <span class="n">M1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M2b</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">M3b</span> <span class="o">=</span> <span class="n">M3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

            <span class="c1"># merge</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">M1x</span> <span class="o">-</span> <span class="n">M1b</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Nb</span> <span class="o">+</span> <span class="n">Nx</span>
            <span class="n">NNx</span> <span class="o">=</span> <span class="n">Nb</span> <span class="o">*</span> <span class="n">Nx</span>

            <span class="n">M4</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">M4x</span>
                <span class="o">+</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">NNx</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">NNx</span> <span class="o">+</span> <span class="n">Nx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">3</span>
                <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M2x</span> <span class="o">+</span> <span class="n">Nx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M2b</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">*</span> <span class="n">M3x</span> <span class="o">-</span> <span class="n">Nx</span> <span class="o">*</span> <span class="n">M3b</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
            <span class="p">)</span>

            <span class="n">M3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">M3x</span> <span class="o">+</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">NNx</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">-</span> <span class="n">Nx</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nb</span> <span class="o">*</span> <span class="n">M2x</span> <span class="o">-</span> <span class="n">Nx</span> <span class="o">*</span> <span class="n">M2b</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">M2x</span> <span class="o">+</span> <span class="n">d</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">NNx</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">M1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">N</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="c1"># calculate kurtosis</span>
        <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">M4</span> <span class="o">/</span> <span class="n">M2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">kurtosis</span></div></div>


<div class="viewcode-block" id="StandardDeviation"><a class="viewcode-back" href="../../../../api/podpac.algorithm.StandardDeviation.html#podpac.algorithm.StandardDeviation">[docs]</a><span class="k">class</span> <span class="nc">StandardDeviation</span><span class="p">(</span><span class="n">Variance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the standard deviation across dimension(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StandardDeviation.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.StandardDeviation.html#podpac.algorithm.StandardDeviation.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the standard deviation across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Standard deviation of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="StandardDeviation.reduce_chunked"><a class="viewcode-back" href="../../../../api/podpac.algorithm.StandardDeviation.html#podpac.algorithm.StandardDeviation.reduce_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the standard deviation across a chunk</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs : iterable</span>
<span class="sd">            Iterable of sources</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Standard deviation of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">StandardDeviation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">reduce_chunked</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Median"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Median.html#podpac.algorithm.Median">[docs]</a><span class="k">class</span> <span class="nc">Median</span><span class="p">(</span><span class="n">ReduceOrthogonal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the median across dimension(s)</span>

<span class="sd">    Example</span>
<span class="sd">    ---------</span>
<span class="sd">    coords.dims == [&#39;lat&#39;, &#39;lon&#39;, &#39;time&#39;]</span>
<span class="sd">    median = Median(source=node, dims=[&#39;lat&#39;, &#39;lon&#39;])</span>
<span class="sd">    o = median.eval(coords)</span>
<span class="sd">    o.dims == [&#39;time&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Median.reduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.Median.html#podpac.algorithm.Median.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the median across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Median of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">Percentile</span><span class="p">(</span><span class="n">ReduceOrthogonal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the percentile across dimension(s)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    percentile : TYPE</span>
<span class="sd">        Description</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">percentile</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the percentile across dimension(s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : UnitsDataArray</span>
<span class="sd">            Source data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        UnitsDataArray</span>
<span class="sd">            Percentile of the source data over dims</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims_axes</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Time-Grouped Reduce</span>
<span class="c1"># =============================================================================</span>

<span class="n">_REDUCE_FUNCTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;var&quot;</span><span class="p">,</span> <span class="s2">&quot;custom&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="GroupReduce"><a class="viewcode-back" href="../../../../api/podpac.algorithm.GroupReduce.html#podpac.algorithm.GroupReduce">[docs]</a><span class="k">class</span> <span class="nc">GroupReduce</span><span class="p">(</span><span class="n">UnaryAlgorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group a time-dependent source node and then compute a statistic for each result.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    custom_reduce_fn : function</span>
<span class="sd">        required if reduce_fn is &#39;custom&#39;.</span>
<span class="sd">    groupby : str</span>
<span class="sd">        datetime sub-accessor. Currently &#39;dayofyear&#39; is the enabled option.</span>
<span class="sd">    reduce_fn : str</span>
<span class="sd">        builtin xarray groupby reduce function, or &#39;custom&#39;.</span>
<span class="sd">    source : podpac.Node</span>
<span class="sd">        Source node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_repr_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;groupby&quot;</span><span class="p">,</span> <span class="s2">&quot;reduce_fn&quot;</span><span class="p">]</span>
    <span class="n">coordinates_source</span> <span class="o">=</span> <span class="n">NodeTrait</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># see https://github.com/pydata/xarray/blob/eeb109d9181c84dfb93356c5f14045d839ee64cb/xarray/core/accessors.py#L61</span>
    <span class="n">groupby</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">CaselessStrEnum</span><span class="p">([</span><span class="s2">&quot;dayofyear&quot;</span><span class="p">,</span> <span class="s2">&quot;weekofyear&quot;</span><span class="p">,</span> <span class="s2">&quot;season&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">],</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reduce_fn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">CaselessStrEnum</span><span class="p">(</span><span class="n">_REDUCE_FUNCTIONS</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">custom_reduce_fn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Any</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_source_coordinates</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">Coordinates</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;coordinates_source&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_default_coordinates_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>

<div class="viewcode-block" id="GroupReduce.eval"><a class="viewcode-back" href="../../../../api/podpac.algorithm.GroupReduce.html#podpac.algorithm.GroupReduce.eval">[docs]</a>    <span class="nd">@common_doc</span><span class="p">(</span><span class="n">COMMON_DOC</span><span class="p">)</span>
    <span class="nd">@node_eval</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates this nodes using the supplied coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : podpac.Coordinates</span>
<span class="sd">            {requested_coordinates}</span>
<span class="sd">        output : podpac.UnitsDataArray, optional</span>
<span class="sd">            {eval_output}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        {eval_return}</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If source it not time-depended (required by this node).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">source_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>

        <span class="c1"># group</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">source_output</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">)</span>

        <span class="c1"># reduce</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_fn</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_reduce_fn</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># standard, e.g. grouped.median(&#39;time&#39;)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_fn</span><span class="p">)(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">podpac</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">merge_dims</span><span class="p">(</span>
                <span class="p">[</span><span class="n">coordinates</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span> <span class="n">Coordinates</span><span class="p">([</span><span class="n">out</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]],</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])]</span>
            <span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_output_array</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>

        <span class="c1">## map</span>
        <span class="c1"># eval_time = xr.DataArray(coordinates.coords[&quot;time&quot;])</span>
        <span class="c1"># E = getattr(eval_time.dt, self.groupby)</span>
        <span class="c1"># out = out.sel(**{self.groupby: E}).rename({self.groupby: &quot;time&quot;})</span>
        <span class="c1"># output[:] = out.transpose(*output.dims).data</span>

        <span class="k">return</span> <span class="n">output</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default node reference/name in node definitions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Default node reference/name in node definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">base_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_fn</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">ResampleReduce</span><span class="p">(</span><span class="n">UnaryAlgorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample a time-dependent source node using a statistical operation to achieve the result.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    custom_reduce_fn : function</span>
<span class="sd">        required if reduce_fn is &#39;custom&#39;.</span>
<span class="sd">    resampleby : str</span>
<span class="sd">        datetime sub-accessor. Currently &#39;dayofyear&#39; is the enabled option.</span>
<span class="sd">    reduce_fn : str</span>
<span class="sd">        builtin xarray groupby reduce function, or &#39;custom&#39;.</span>
<span class="sd">    source : podpac.Node</span>
<span class="sd">        Source node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_repr_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;resampleby&quot;</span><span class="p">,</span> <span class="s2">&quot;reduce_fn&quot;</span><span class="p">]</span>
    <span class="n">coordinates_source</span> <span class="o">=</span> <span class="n">NodeTrait</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># see https://github.com/pydata/xarray/blob/eeb109d9181c84dfb93356c5f14045d839ee64cb/xarray/core/accessors.py#L61</span>
    <span class="n">resample</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># could add season, month, etc</span>
    <span class="n">reduce_fn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">CaselessStrEnum</span><span class="p">(</span><span class="n">_REDUCE_FUNCTIONS</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">custom_reduce_fn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Any</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_source_coordinates</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">Coordinates</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;coordinates_source&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_default_coordinates_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>

    <span class="nd">@common_doc</span><span class="p">(</span><span class="n">COMMON_DOC</span><span class="p">)</span>
    <span class="nd">@node_eval</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates this nodes using the supplied coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : podpac.Coordinates</span>
<span class="sd">            {requested_coordinates}</span>
<span class="sd">        output : podpac.UnitsDataArray, optional</span>
<span class="sd">            {eval_output}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        {eval_return}</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If source it not time-depended (required by this node).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">source_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>

        <span class="c1"># group</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">source_output</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="p">)</span>

        <span class="c1"># reduce</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_fn</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_reduce_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># standard, e.g. grouped.median(&#39;time&#39;)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_fn</span><span class="p">)()</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">podpac</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">merge_dims</span><span class="p">(</span>
                <span class="p">[</span><span class="n">coordinates</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span> <span class="n">Coordinates</span><span class="p">([</span><span class="n">out</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]],</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])]</span>
            <span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_output_array</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>

        <span class="c1">## map</span>
        <span class="c1"># eval_time = xr.DataArray(coordinates.coords[&quot;time&quot;])</span>
        <span class="c1"># E = getattr(eval_time.dt, self.groupby)</span>
        <span class="c1"># out = out.sel(**{self.groupby: E}).rename({self.groupby: &quot;time&quot;})</span>
        <span class="c1"># output[:] = out.transpose(*output.dims).data</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default node reference/name in node definitions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Default node reference/name in node definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">base_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_fn</span><span class="p">)</span>


<div class="viewcode-block" id="DayOfYear"><a class="viewcode-back" href="../../../../api/podpac.algorithm.DayOfYear.html#podpac.algorithm.DayOfYear">[docs]</a><span class="k">class</span> <span class="nc">DayOfYear</span><span class="p">(</span><span class="n">GroupReduce</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group a time-dependent source node by day of year and compute a statistic for each group.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    custom_reduce_fn : function</span>
<span class="sd">        required if reduce_fn is &#39;custom&#39;.</span>
<span class="sd">    reduce_fn : str</span>
<span class="sd">        builtin xarray groupby reduce function, or &#39;custom&#39;.</span>
<span class="sd">    source : podpac.Node</span>
<span class="sd">        Source node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">groupby</span> <span class="o">=</span> <span class="s2">&quot;dayofyear&quot;</span></div>


<span class="k">class</span> <span class="nc">DayOfYearWindow</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This applies a function over a moving window around day-of-year in the requested coordinates.</span>
<span class="sd">    It includes the ability to rescale the input/outputs. Note if, the input coordinates include multiple years, the</span>
<span class="sd">    moving window will include all of the data inside the day-of-year window.</span>

<span class="sd">    Users need to implement the &#39;function&#39; method.</span>

<span class="sd">    Attributes</span>
<span class="sd">    -----------</span>
<span class="sd">    source: podpac.Node</span>
<span class="sd">        The source node from which the statistics will be computed</span>
<span class="sd">    window: int, optional</span>
<span class="sd">        Default is 0. The size of the window over which to compute the distrubtion. This is always centered about the</span>
<span class="sd">        day-of-year. The total number of days is always an odd number. For example, window=2 and window=3 will compute</span>
<span class="sd">        the beta distribution for [x-1, x, x + 1] and report it as the result for x, where x is a day of the year.</span>
<span class="sd">    scale_max: podpac.Node, optional</span>
<span class="sd">        Default is None. A source dataset that can be used to scale the maximum value of the source function so that it</span>
<span class="sd">        will fall between [0, 1]. If None, uses self.scale_float[0].</span>
<span class="sd">    scale_min: podpac.Node, optional</span>
<span class="sd">        Default is None. A source dataset that can be used to scale the minimum value of the source function so that it</span>
<span class="sd">        will fall between [0, 1]. If None, uses self.scale_float[1].</span>
<span class="sd">    scale_float: list, optional</span>
<span class="sd">        Default is []. Floating point numbers used to scale the max [0] and min [1] of the source so that it falls</span>
<span class="sd">        between [0, 1]. If scale_max or scale_min are defined, this property is ignored. If these are defined, the data</span>
<span class="sd">        will be rescaled only if rescale=True below.</span>
<span class="sd">        If None and scale_max/scale_min are not defined, the data is not scaled in any way.</span>
<span class="sd">    rescale: bool, optional</span>
<span class="sd">        Rescales the output data after being scaled from scale_float or scale_min/max</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">podpac</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scale_max</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">podpac</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scale_min</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">podpac</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scale_float</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>

        <span class="c1"># Scale the source to range [0, 1], required for the beta distribution</span>
        <span class="k">if</span> <span class="s2">&quot;scale_max&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">scale_max</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;scale_max&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_float</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_float</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_float</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale_max</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;scale_min&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">scale_min</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;scale_min&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_float</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_float</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_float</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale_min</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;scale_min: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">scale_max: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scale_min</span><span class="p">,</span> <span class="n">scale_max</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">scale_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scale_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="n">scale_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale_max</span> <span class="o">-</span> <span class="n">scale_min</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                <span class="n">source</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">source</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Make the output coordinates with day-of-year as time</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requested_coordinates</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coordinates</span><span class="p">})</span>
        <span class="n">dsdoy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">))</span>
        <span class="n">latlon_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requested_coordinates</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">time_coords</span> <span class="o">=</span> <span class="n">podpac</span><span class="o">.</span><span class="n">Coordinates</span><span class="p">([</span><span class="n">dsdoy</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">podpac</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">merge_dims</span><span class="p">([</span><span class="n">latlon_coords</span><span class="p">,</span> <span class="n">time_coords</span><span class="p">])</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_requested_coordinates</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_output_array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># if all-nan input, no need to calculate</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">output</span>

        <span class="c1"># convert source time coords to day-of-year as well</span>
        <span class="n">sdoy</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>

        <span class="c1"># loop over each day of year and compute window</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsdoy</span><span class="p">):</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Working on doy </span><span class="si">{doy}</span><span class="s2"> (</span><span class="si">{i}</span><span class="s2">/</span><span class="si">{ld}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doy</span><span class="o">=</span><span class="n">doy</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ld</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dsdoy</span><span class="p">)))</span>

            <span class="c1"># If either the start or end runs over the year, we need to do an OR on the bool index</span>
            <span class="c1"># -----&gt;s....&lt;=e------   .in -out</span>
            <span class="c1"># ..&lt;=e-----------&gt;s..</span>
            <span class="n">do_or</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">doy</span> <span class="o">-</span> <span class="n">win</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="mi">365</span>
                <span class="n">do_or</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">end</span> <span class="o">=</span> <span class="n">doy</span> <span class="o">+</span> <span class="n">win</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">-=</span> <span class="mi">365</span>
                <span class="n">do_or</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">do_or</span><span class="p">:</span>
                <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdoy</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sdoy</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdoy</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sdoy</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>

            <span class="c1"># Scipy&#39;s beta function doesn&#39;s support multi-dimensional arrays, so we have to loop over lat/lon/alt</span>
            <span class="n">lat_f</span> <span class="o">=</span> <span class="n">lon_f</span> <span class="o">=</span> <span class="n">alt_f</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;lat&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">lat_f</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="s2">&quot;lon&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">lon_f</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="s2">&quot;alt&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">alt_f</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="k">for</span> <span class="n">alt</span> <span class="ow">in</span> <span class="n">alt_f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">lat_f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="n">lon_f</span><span class="p">:</span>
                        <span class="c1"># _log.debug(f&#39;lat, lon, alt = {lat}, {lon}, {alt})</span>
                        <span class="n">loc_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span><span class="p">])</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

                        <span class="n">data</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="o">**</span><span class="n">loc_dict</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                            <span class="k">continue</span>

                        <span class="c1"># Fit function to the particular point</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loc_dict</span><span class="p">][{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loc_dict</span><span class="p">][{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}])</span>

        <span class="c1"># Rescale the outputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_outputs</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">scale_max</span><span class="p">,</span> <span class="n">scale_min</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Child classes need to implement this function. It is applied over the data and needs&quot;</span>
            <span class="s2">&quot; to populate the output.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">rescale_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">scale_max</span><span class="p">,</span> <span class="n">scale_min</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span> <span class="o">*</span> <span class="p">(</span><span class="n">scale_max</span> <span class="o">-</span> <span class="n">scale_min</span><span class="p">))</span> <span class="o">+</span> <span class="n">scale_min</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017-2020, Creare

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>