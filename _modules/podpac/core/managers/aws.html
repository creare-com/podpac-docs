

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>podpac.core.managers.aws &mdash; 1.2.0</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
  
  
  
    <link rel="canonical" href="https://podpac.org_modules/podpac/core/managers/aws.html"/>
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/icon.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../why-podpac.html">Why PODPAC?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datasets.html">Supported Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Development Roadmap</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/coordinates.html">Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/nodes.html">Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/pipelines.html">Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/cache.html">Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/earthdata.html">NASA Earth Data Login</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/api.html">API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/aws.html">AWS Lambda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/docs.html">Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">PODPAC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>podpac.core.managers.aws</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for podpac.core.managers.aws</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Lambda is `Node` manager, which executes the given `Node` on an AWS Lambda</span>
<span class="sd">function.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">botocore</span>
<span class="kn">import</span> <span class="nn">traitlets</span> <span class="k">as</span> <span class="nn">tl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">podpac.core.units</span> <span class="kn">import</span> <span class="n">UnitsDataArray</span>
<span class="kn">from</span> <span class="nn">podpac.core.settings</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">podpac.core.node</span> <span class="kn">import</span> <span class="n">COMMON_NODE_DOC</span><span class="p">,</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">podpac.core.utils</span> <span class="kn">import</span> <span class="n">common_doc</span><span class="p">,</span> <span class="n">JSONEncoder</span>
<span class="kn">from</span> <span class="nn">podpac</span> <span class="kn">import</span> <span class="n">version</span>

<span class="c1"># Set up logging</span>
<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">COMMON_DOC</span> <span class="o">=</span> <span class="n">COMMON_NODE_DOC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">LambdaException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Exception during execution of a Lambda node&quot;&quot;&quot;</span>

    <span class="k">pass</span>


<div class="viewcode-block" id="Lambda"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda">[docs]</a><span class="k">class</span> <span class="nc">Lambda</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `Node` wrapper to evaluate source on AWS Lambda function</span>
<span class="sd">    </span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    aws_access_key_id : str, optional</span>
<span class="sd">        Access key id from AWS credentials. If :attr:`session` is provided, this attribute will be ignored. Overrides :dict:`podpac.settings`.</span>
<span class="sd">    aws_region_name : str, optional</span>
<span class="sd">        Name of the AWS region. If :attr:`session` is provided, this attribute will be ignored. Overrides :dict:`podpac.settings`.</span>
<span class="sd">    aws_secret_access_key : str</span>
<span class="sd">        Access key value from AWS credentials. If :attr:`session` is provided, this attribute will be ignored. Overrides :dict:`podpac.settings`.</span>
<span class="sd">    function_name : str, optional</span>
<span class="sd">        Name of the lambda function to use or create. Defaults to :str:`podpac.settings[&quot;FUNCTION_NAME&quot;]` or &quot;podpac-lambda-autogen&quot;.</span>
<span class="sd">    function_timeout : int, optional</span>
<span class="sd">        Timeout of the lambda function, in seconds. Defaults to 600.</span>
<span class="sd">    function_triggers : list of str, optional</span>
<span class="sd">        Methods to trigger this function. May only include [&quot;eval&quot;, &quot;S3&quot;, &quot;APIGateway&quot;]. During the :meth:`self.build()` process, this list will determine which AWS resources are linked to Lambda function. Defaults to [&quot;eval&quot;].</span>
<span class="sd">    function_role_name : str, optional</span>
<span class="sd">        Name of the AWS role created for lambda function. Defaults to :str:`podpac.settings[&quot;FUNCTION_ROLE_NAME&quot;]` or &quot;podpac-lambda-autogen&quot;.</span>
<span class="sd">    function_s3_bucket : str, optional</span>
<span class="sd">        S3 bucket name to use with lambda function. Defaults to :str:`podpac.settings[&quot;S3_BUCKET_NAME&quot;]` or &quot;podpac-autogen-&lt;timestamp&gt;&quot; with the timestamp to ensure uniqueness.</span>
<span class="sd">    eval_settings : dict, optional</span>
<span class="sd">        Default is podpac.settings. PODPAC settings that will be used to evaluate the Lambda function.</span>

<span class="sd">    Other Attributes</span>
<span class="sd">    ----------------</span>
<span class="sd">    attrs : dict</span>
<span class="sd">        Additional attributes passed on to the Lambda definition of the base node</span>
<span class="sd">    download_result : Bool</span>
<span class="sd">        Flag that indicated whether node should wait to download the data.</span>
<span class="sd">    function_api_description : str, optional</span>
<span class="sd">        Description for the AWS API Gateway resource</span>
<span class="sd">    function_api_endpoint : str, optional</span>
<span class="sd">        Endpoint path for API Gateway. Defaults to &quot;eval&quot;.</span>
<span class="sd">    function_api_name : str, optional</span>
<span class="sd">        AWS resource name for the API Gateway. Defaults to :attr:`self.function_name` + &quot;-api&quot;.</span>
<span class="sd">    function_api_stage : str, optional</span>
<span class="sd">        Stage name for the API gateway. Defaults to &quot;prod&quot;.</span>
<span class="sd">    function_api_tags : dict, optional</span>
<span class="sd">        AWS Tags for API Gateway resource. Defaults to :attr:`self.function_tags`.</span>
<span class="sd">    function_api_version : str, optional</span>
<span class="sd">        API Gateway version. Defaults to :meth:`podpac.verions.semver()`.</span>
<span class="sd">    function_description : str, optional</span>
<span class="sd">        Description for the AWS Lambda function resource</span>
<span class="sd">    function_env_variables : dict, optional</span>
<span class="sd">        Environment variables to use within the lambda function.</span>
<span class="sd">    function_eval_trigger : str, optional</span>
<span class="sd">        Function trigger to use during node eval process. Must be on of &quot;eval&quot; (default), &quot;S3&quot;, or &quot;APIGateway&quot;.</span>
<span class="sd">    function_handler : str, optional</span>
<span class="sd">        Handler method in Lambda function. Defaults to &quot;handler.handler&quot;.</span>
<span class="sd">    function_memory : int, optional</span>
<span class="sd">        Memory allocated for each Lambda function. Defaults to 2048 MB.</span>
<span class="sd">    function_restrict_pipelines : list, optional</span>
<span class="sd">        List of Node hashes (see :class:`podpac.Node.hash`). </span>
<span class="sd">        Restricts lambda function evaluation to specific Node definitions.</span>
<span class="sd">    function_role_assume_policy_document : dict, optional.</span>
<span class="sd">        Assume policy document for role created. Defaults to allowing role to assume Lambda function.</span>
<span class="sd">    function_role_description : str, optional</span>
<span class="sd">        Description for the AWS role resource</span>
<span class="sd">    function_role_policy_arns : list of str, optional</span>
<span class="sd">        Managed role policy ARNs to attach to role.</span>
<span class="sd">    function_role_policy_document : dict, optional</span>
<span class="sd">        Inline role policies to put in role.</span>
<span class="sd">    function_role_tags : dict, optional</span>
<span class="sd">        AWS Tags for role resource. Defaults to :attr:`self.function_tags`.</span>
<span class="sd">    function_s3_dependencies_key : str, optional</span>
<span class="sd">        S3 path to copy and reference podpac dependencies. Defaults to &quot;podpac_deps_&lt;semver&gt;.zip&quot;.</span>
<span class="sd">    function_s3_input : str, optional</span>
<span class="sd">        Folder in :attr:`self.function_s3_bucket` to store input pipelines when &quot;S3&quot; is included in :attr:`self.function_triggers`. Defaults to &quot;input&quot;.</span>
<span class="sd">    function_s3_output : str, optional</span>
<span class="sd">        Folder in :attr:`self.function_s3_bucket` to watch for output when &quot;S3&quot; is included in :attr:`self.function_triggers`. Defaults to &quot;output&quot;.</span>
<span class="sd">    function_s3_tags : dict, optional</span>
<span class="sd">        AWS Tags for S3 bucket resource. Defaults to :attr:`self.function_tags`.</span>
<span class="sd">    function_source_bucket : str, optional</span>
<span class="sd">        S3 Bucket to use for released podpac distribution during :meth:`self.build()` process. Defaults to &quot;podpac-dist&quot;. This bucket is managed by the PODPAC distribution team.</span>
<span class="sd">    function_source_dependencies_key : str, optional</span>
<span class="sd">        S3 path within :attr:`self.function_source_bucket` to source podpac dependencies archive during :meth:`self.build()` process. Defaults to &quot;&lt;semver&gt;/podpac_deps.zip&quot;.</span>
<span class="sd">    function_source_dependencies_zip : str, optional</span>
<span class="sd">        Override :attr:`self.function_source_dependencies_key` and upload custom source podpac dependencies archive to :attr:`self.function_s3_bucket` during :meth:`self.build()` process.</span>
<span class="sd">    function_source_dist_key : str, optional</span>
<span class="sd">        S3 path within :attr:`self.function_source_bucket` to source podpac dist archive during :meth:`self.build()` process. Defaults to &quot;&lt;semver&gt;/podpac_dist.zip&quot;.</span>
<span class="sd">    function_source_dist_zip : str, optional</span>
<span class="sd">        Override :attr:`self.function_source_dist_key` and create lambda function using custom source podpac dist archive to :attr:`self.function_s3_bucket` during :meth:`self.build()` process.</span>
<span class="sd">    function_tags : dict, optional</span>
<span class="sd">        AWS Tags for Lambda function resource. Defaults to :dict:`podpac.settings[&quot;AWS_TAGS&quot;]` or {}.</span>
<span class="sd">    session : :class:`podpac.managers.aws.Session`</span>
<span class="sd">        AWS Session to use for this node.</span>
<span class="sd">    source : :class:`podpac.Node`</span>
<span class="sd">        Node to be evaluated on the Lambda function.</span>
<span class="sd">    source_output_format : str</span>
<span class="sd">        Output format for the evaluated results of `source`</span>
<span class="sd">    source_output_name : str</span>
<span class="sd">        Output name for the evaluated results of `source`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># aws parameters - defaults are handled in Session</span>
    <span class="n">aws_access_key_id</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aws_secret_access_key</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aws_region_name</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_session_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># defaults to &quot;settings&quot; if None</span>
        <span class="k">return</span> <span class="n">Session</span><span class="p">(</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_access_key_id</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_secret_access_key</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_region_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># general function parameters</span>
    <span class="n">function_eval_trigger</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Enum</span><span class="p">([</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="s2">&quot;S3&quot;</span><span class="p">,</span> <span class="s2">&quot;APIGateway&quot;</span><span class="p">],</span> <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># lambda function parameters</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_triggers</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">Enum</span><span class="p">([</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="s2">&quot;S3&quot;</span><span class="p">,</span> <span class="s2">&quot;APIGateway&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_handler</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;handler.handler&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_description</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;PODPAC Lambda Function (https://podpac.org)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_env_variables</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="p">{})</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># environment vars in function</span>
    <span class="n">function_tags</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># key: value for tags on function (and any created roles)</span>
    <span class="n">function_timeout</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_memory</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_source_dist_zip</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span>
        <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1"># override published podpac archive with local file</span>
    <span class="n">function_source_dependencies_zip</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span>
        <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1"># override published podpac deps archive with local file</span>
    <span class="n">function_source_bucket</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;podpac-dist&quot;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_source_dist_key</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_source_dependencies_key</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_allow_unsafe_eval</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_restrict_pipelines</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(),</span> <span class="n">default_value</span><span class="o">=</span><span class="p">[])</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_arn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_last_modified</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_version</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_code_sha256</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_triggers</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="p">{},</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_valid</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># raw response from AWS on &quot;get_&quot;</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_name_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_NAME&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;podpac-lambda-autogen&quot;</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_NAME&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_triggers&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_triggers_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_eval_trigger</span> <span class="o">!=</span> <span class="s2">&quot;eval&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_eval_trigger</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_source_dist_key&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_source_dist_key_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;dev&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/podpac_dist.zip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_source_dependencies_key&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_source_dependencies_key_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;dev&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/podpac_deps.zip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_tags&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_tags_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_TAGS&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># role parameters</span>
    <span class="n">function_role_name</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_role_description</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;PODPAC Lambda Role&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_role_policy_document</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below - can be none</span>
    <span class="n">function_role_policy_arns</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
        <span class="n">default_value</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
        <span class="p">]</span>  <span class="c1"># allows read/write to cloudwatch</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_role_assume_policy_document</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_role_tags</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">_function_role_arn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_role</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># raw response from AWS on &quot;get_&quot;</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_role_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_role_name_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_ROLE_NAME&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_ROLE_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;podpac-lambda-autogen&quot;</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_ROLE_NAME&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_role_policy_document&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_role_policy_document_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># enable role to be run by lambda - this document is defined by AWS</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:DeleteObject&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:ReplicateObject&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:ListBucket&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:ListMultipartUploadParts&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:ListBucketByTags&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:GetBucketTagging&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:ListBucketVersions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:AbortMultipartUpload&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:GetObjectTagging&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:ListBucketMultipartUploads&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:GetBucketLocation&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;s3:GetObjectVersion&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;arn:aws:s3:::</span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">)],</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_role_assume_policy_document&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_role_assume_policy_document_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># enable role to be run by lambda - this document is defined by AWS</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span> <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda.amazonaws.com&quot;</span><span class="p">},</span> <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span><span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_role_tags&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_role_tags_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_tags</span>

    <span class="c1"># s3 parameters</span>
    <span class="n">function_s3_bucket</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_s3_dependencies_key</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span>  <span class="c1"># see default below</span>
    <span class="n">function_s3_input</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span>  <span class="c1"># see default below</span>
    <span class="n">function_s3_output</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span>  <span class="c1"># see default below</span>
    <span class="n">function_s3_tags</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span>  <span class="c1"># see default below</span>
    <span class="n">_bucket</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># raw response from AWS on &quot;get_&quot;</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_s3_bucket&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_s3_bucket_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;S3_BUCKET_NAME&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;podpac-autogen-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># must be globally unique</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_s3_input&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_s3_input_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_S3_INPUT&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_S3_INPUT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;input/&quot;</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_S3_INPUT&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_s3_output&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_s3_output_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_S3_OUTPUT&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_S3_OUTPUT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;output/&quot;</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_S3_OUTPUT&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_s3_tags&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_s3_tags_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_tags</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_s3_dependencies_key&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_s3_dependencies_key_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_DEPENDENCIES_KEY&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_DEPENDENCIES_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;podpac_deps_</span><span class="si">{}</span><span class="s2">.zip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">semver</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_DEPENDENCIES_KEY&quot;</span><span class="p">]</span>

    <span class="c1"># api gateway parameters</span>
    <span class="n">function_api_name</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_api_description</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_api_version</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">semver</span><span class="p">()))</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_api_tags</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_api_stage</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function_api_endpoint</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_api_id</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># will create api if None</span>
    <span class="n">_function_api_url</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_function_api_resource_id</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_api</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># raw response from AWS on &quot;get_&quot;</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_api_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_api_name_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-api&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_api_description&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_api_description_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PODPAC Lambda REST API for </span><span class="si">{}</span><span class="s2"> function&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_api_tags&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_api_tags_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_tags</span>

    <span class="c1"># budget parameters</span>
    <span class="n">function_budget_amount</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_budget_email</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_budget_name</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># see default below</span>
    <span class="n">function_budget_currency</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_budget</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># raw response from AWS on &quot;get_&quot;</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_budget_amount&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_budget_amount_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_BUDGET_AMOUNT&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_budget_email&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_budget_email_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># raise error if e-mail is not provided in settings</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_BUDGET_EMAIL&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Budget notification e-mail is required when setting up a budget&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_BUDGET_EMAIL&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;function_budget_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_function_budget_name_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-budget&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>

    <span class="c1"># podpac node parameters</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">source_output_format</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;netcdf&quot;</span><span class="p">)</span>
    <span class="n">source_output_name</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span>
    <span class="n">download_result</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">force_compute</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Bool</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">eval_settings</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;source_output_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_source_output_name_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;force_compute&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_force_compute_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_FORCE_COMPUTE&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_FORCE_COMPUTE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;FUNCTION_FORCE_COMPUTE&quot;</span><span class="p">]</span>

    <span class="nd">@tl</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;eval_settings&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_eval_settings_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The pipeline of this manager is the aggregation of the source node definition and the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">out_node</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="n">out_node</span><span class="p">][</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_output_format</span><span class="p">}</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_settings</span>
        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="Lambda.eval"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.eval">[docs]</a>    <span class="nd">@common_doc</span><span class="p">(</span><span class="n">COMMON_DOC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the source node on the AWS Lambda Function at the given coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;source&#39; node must be defined to eval&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_eval_trigger</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_invoke</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_eval_trigger</span> <span class="o">==</span> <span class="s2">&quot;S3&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_s3</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_eval_trigger</span> <span class="o">==</span> <span class="s2">&quot;APIGateway&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;APIGateway trigger not yet implemented through eval&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function trigger is not one of &#39;eval&#39;, &#39;S3&#39;, or &#39;APIGateway&#39;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.build"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build Lambda function and associated resources on AWS</span>
<span class="sd">        to run PODPAC pipelines</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: move towards an architecture where the &quot;create_&quot; functions repair on each build</span>
        <span class="c1"># and skip when the resources already exist</span>

        <span class="c1"># see if current setup is valid, if so just return</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Current cloud resources will support this PODPAC lambda function&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: how much &quot;importing&quot; do we want to do? Currently, this will see if the cloud resource is available</span>
        <span class="c1"># and if so, assume that it will work with the function setup</span>

        <span class="c1"># self.validate updates current properties (self.function, self.role, self.bucket, self.api)</span>
        <span class="c1"># create default role if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_role</span><span class="p">()</span>

            <span class="c1"># after creating a role, you need to wait ~10 seconds before its active and will work with the lambda function</span>
            <span class="c1"># this is not cool</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># create function</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_function</span><span class="p">()</span>

            <span class="c1"># after creating a role, you need to wait ~5 seconds before its active and will return an arn</span>
            <span class="c1"># this is also not cool</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># TODO: check to make sure function and role work together</span>

        <span class="c1"># create API gateway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_api</span><span class="p">()</span>

        <span class="c1"># TODO: check to make sure function and API work together</span>

        <span class="c1"># create S3 bucket - this will skip pieces that already exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">()</span>

        <span class="c1"># create budget, if defined</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_budget_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_budget</span><span class="p">()</span>

        <span class="c1"># check to see if setup is valid after creation</span>
        <span class="c1"># TODO: remove this in favor of something more granular??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully built AWS resources to support function </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Lambda.validate"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate cloud resources and interoperability of resources for </span>
<span class="sd">        PODPAC usage</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raise_exceptions : bool, optional</span>
<span class="sd">            Raise validation errors when encountered</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: I don&#39;t know if this is the right architecture to handle validation</span>
        <span class="c1"># perhaps we just want to improve the &quot;create_&quot; methods to be self-healing</span>

        <span class="k">def</span> <span class="nf">_raise</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raise_exceptions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># get currently defined resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_role</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_function</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_budget</span><span class="p">()</span>

        <span class="c1"># check that each resource has a valid configuration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_role</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_raise</span><span class="p">(</span><span class="s2">&quot;Failed to validate role&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_function</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_raise</span><span class="p">(</span><span class="s2">&quot;Failed to validate function&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_bucket</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_raise</span><span class="p">(</span><span class="s2">&quot;Failed to validate bucket&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_api</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_raise</span><span class="p">(</span><span class="s2">&quot;Failed to validate API&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_budget</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_raise</span><span class="p">(</span><span class="s2">&quot;Failed to validate budget&quot;</span><span class="p">)</span>

        <span class="c1"># check that the integration of resources is correct</span>

        <span class="c1"># check that role_arn is the same as function configured role</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;Role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_role_arn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_raise</span><span class="p">(</span><span class="s2">&quot;Function role ARN is not the same as role ARN for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span><span class="p">))</span>

        <span class="c1"># if it makes it to the end, its valid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Lambda.delete"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all cloud resources associated with function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        confirm : bool, optional</span>
<span class="sd">            Must pass in confirm paramter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing all cloud resources associated with this Lamba node&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_triggers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_function</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_role</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_api</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_bucket</span><span class="p">(</span><span class="n">delete_objects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_budget</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must pass confirm=True to delete all AWS resources&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.describe"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show a description of the Lambda Utilities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: change this to format strings when we deprecate py 2</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;(staged)&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_valid</span> <span class="k">else</span> <span class="s2">&quot;(built)&quot;</span>

        <span class="c1"># source dist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_valid</span><span class="p">:</span>
            <span class="n">source_dist</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_zip</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_zip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="s2">&quot;s3://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_source_bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_key</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_code_sha256</span>

        <span class="c1"># source deps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_valid</span><span class="p">:</span>
            <span class="n">source_deps</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dependencies_zip</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dependencies_zip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="s2">&quot;s3://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_source_bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dependencies_key</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_deps</span> <span class="o">=</span> <span class="s2">&quot;s3://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_dependencies_key</span><span class="p">)</span>

        <span class="c1"># only show API if built or if its proposed in triggers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_valid</span> <span class="ow">and</span> <span class="s2">&quot;APIGatway&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">):</span>
            <span class="n">api_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    API</span>
<span class="s2">        Name: </span><span class="si">{function_api_name}</span><span class="s2"></span>
<span class="s2">        Description: </span><span class="si">{function_api_description}</span><span class="s2"></span>
<span class="s2">        ID: </span><span class="si">{_function_api_id}</span><span class="s2"></span>
<span class="s2">        Resource ID: </span><span class="si">{_function_api_resource_id}</span><span class="s2"></span>
<span class="s2">        Version: </span><span class="si">{function_api_version}</span><span class="s2"></span>
<span class="s2">        Tags: </span><span class="si">{function_api_tags}</span><span class="s2"></span>
<span class="s2">        Stage: </span><span class="si">{function_api_stage}</span><span class="s2"></span>
<span class="s2">        Endpoint: </span><span class="si">{function_api_endpoint}</span><span class="s2"></span>
<span class="s2">        URL: </span><span class="si">{_function_api_url}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">function_api_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_name</span><span class="p">,</span>
                <span class="n">function_api_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_description</span><span class="p">,</span>
                <span class="n">_function_api_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_api_id</span><span class="p">,</span>
                <span class="n">_function_api_resource_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_api_resource_id</span><span class="p">,</span>
                <span class="n">function_api_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_version</span><span class="p">,</span>
                <span class="n">function_api_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_tags</span><span class="p">,</span>
                <span class="n">function_api_stage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_stage</span><span class="p">,</span>
                <span class="n">function_api_endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_endpoint</span><span class="p">,</span>
                <span class="n">_function_api_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_api_url</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">api_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># only show budget if its defined</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_budget_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">budget_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Budget</span>
<span class="s2">        Name: </span><span class="si">{function_budget_name}</span><span class="s2"></span>
<span class="s2">        Amount: </span><span class="si">{function_budget_amount}</span><span class="s2"></span>
<span class="s2">        Currency: </span><span class="si">{function_budget_currency}</span><span class="s2"></span>
<span class="s2">        E-mail: </span><span class="si">{function_budget_email}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">function_budget_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_budget_name</span><span class="p">,</span>
                <span class="n">function_budget_amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_budget_amount</span><span class="p">,</span>
                <span class="n">function_budget_currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_budget_currency</span><span class="p">,</span>
                <span class="n">function_budget_email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_budget_email</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">budget_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Lambda Node </span><span class="si">{status}</span><span class="s2"></span>
<span class="s2">    Function</span>
<span class="s2">        Name: </span><span class="si">{function_name}</span><span class="s2"></span>
<span class="s2">        Description: </span><span class="si">{function_description}</span><span class="s2"></span>
<span class="s2">        ARN: </span><span class="si">{_function_arn}</span><span class="s2"></span>
<span class="s2">        Triggers: </span><span class="si">{function_triggers}</span><span class="s2"></span>
<span class="s2">        Handler: </span><span class="si">{function_handler}</span><span class="s2"></span>
<span class="s2">        Environment Variables: </span><span class="si">{function_env_variables}</span><span class="s2"></span>
<span class="s2">        Timeout: </span><span class="si">{function_timeout}</span><span class="s2"> seconds</span>
<span class="s2">        Memory: </span><span class="si">{function_memory}</span><span class="s2"> MB</span>
<span class="s2">        Tags: </span><span class="si">{function_tags}</span><span class="s2"></span>
<span class="s2">        Source Dist: </span><span class="si">{source_dist}</span><span class="s2"></span>
<span class="s2">        Source Dependencies: </span><span class="si">{source_deps}</span><span class="s2"></span>
<span class="s2">        Last Modified: </span><span class="si">{_function_last_modified}</span><span class="s2"></span>
<span class="s2">        Version: </span><span class="si">{_function_version}</span><span class="s2"></span>
<span class="s2">        Restrict Evaluation: </span><span class="si">{function_restrict_pipelines}</span><span class="s2"></span>

<span class="s2">    S3</span>
<span class="s2">        Bucket: </span><span class="si">{function_s3_bucket}</span><span class="s2"></span>
<span class="s2">        Tags: </span><span class="si">{function_s3_tags}</span><span class="s2"></span>
<span class="s2">        Input Folder: </span><span class="si">{function_s3_input}</span><span class="s2"></span>
<span class="s2">        Output Folder: </span><span class="si">{function_s3_output}</span><span class="s2"></span>

<span class="s2">    Role</span>
<span class="s2">        Name: </span><span class="si">{function_role_name}</span><span class="s2"></span>
<span class="s2">        Description: </span><span class="si">{function_role_description}</span><span class="s2"></span>
<span class="s2">        ARN: </span><span class="si">{_function_role_arn}</span><span class="s2"></span>
<span class="s2">        Policy Document: </span><span class="si">{function_role_policy_document}</span><span class="s2"></span>
<span class="s2">        Policy ARNs: </span><span class="si">{function_role_policy_arns}</span><span class="s2"></span>
<span class="s2">        Assume Policy Document: </span><span class="si">{function_role_assume_policy_document}</span><span class="s2"></span>
<span class="s2">        Tags: </span><span class="si">{function_role_tags}</span><span class="s2"></span>

<span class="s2">        </span><span class="si">{api_output}</span><span class="s2"></span>

<span class="s2">        </span><span class="si">{budget_output}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">function_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_description</span><span class="p">,</span>
            <span class="n">function_triggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">,</span>
            <span class="n">function_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_handler</span><span class="p">,</span>
            <span class="n">function_env_variables</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_env_variables</span><span class="p">,</span>
            <span class="n">function_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_timeout</span><span class="p">,</span>
            <span class="n">function_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_memory</span><span class="p">,</span>
            <span class="n">function_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_tags</span><span class="p">,</span>
            <span class="n">source_dist</span><span class="o">=</span><span class="n">source_dist</span><span class="p">,</span>
            <span class="n">source_deps</span><span class="o">=</span><span class="n">source_deps</span><span class="p">,</span>
            <span class="n">_function_arn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span><span class="p">,</span>
            <span class="n">_function_last_modified</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_last_modified</span><span class="p">,</span>
            <span class="n">_function_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_version</span><span class="p">,</span>
            <span class="n">function_restrict_pipelines</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_restrict_pipelines</span><span class="p">,</span>
            <span class="n">function_s3_bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span>
            <span class="n">function_s3_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_tags</span><span class="p">,</span>
            <span class="n">function_s3_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_input</span><span class="p">,</span>
            <span class="n">function_s3_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_output</span><span class="p">,</span>
            <span class="n">function_role_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span><span class="p">,</span>
            <span class="n">function_role_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_description</span><span class="p">,</span>
            <span class="n">function_role_policy_document</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_policy_document</span><span class="p">,</span>
            <span class="n">function_role_policy_arns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_policy_arns</span><span class="p">,</span>
            <span class="n">function_role_assume_policy_document</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_assume_policy_document</span><span class="p">,</span>
            <span class="n">function_role_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_tags</span><span class="p">,</span>
            <span class="n">_function_role_arn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_role_arn</span><span class="p">,</span>
            <span class="n">api_output</span><span class="o">=</span><span class="n">api_output</span><span class="p">,</span>
            <span class="n">budget_output</span><span class="o">=</span><span class="n">budget_output</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>

    <span class="c1"># Function</span>
<div class="viewcode-block" id="Lambda.create_function"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.create_function">[docs]</a>    <span class="k">def</span> <span class="nf">create_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build Lambda function on AWS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Function name is not defined&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_allow_unsafe_eval</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lambda function will allow unsafe evaluation of Nodes with the current settings&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_env_variables</span><span class="p">[</span><span class="s2">&quot;PODPAC_UNSAFE_EVAL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;UNSAFE_EVAL_HASH&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_restrict_pipelines</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lambda function will only run for pipelines: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_restrict_pipelines</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_env_variables</span><span class="p">[</span><span class="s2">&quot;PODPAC_RESTRICT_PIPELINES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_restrict_pipelines</span><span class="p">)</span>

        <span class="c1"># add special tag - value is hash, for lack of better value at this point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span>

        <span class="c1"># if function already exists, this will return existing function</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">create_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_role_arn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_handler</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_description</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_timeout</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_memory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_env_variables</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_tags</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_zip</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_source_bucket</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_key</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set class properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_function</span><span class="p">(</span><span class="n">function</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.update_function"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.update_function">[docs]</a>    <span class="k">def</span> <span class="nf">update_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update lambda function with new parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Function name is not defined&quot;</span><span class="p">)</span>

        <span class="c1"># if function already exists, this will return existing function</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">update_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_zip</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_source_bucket</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dist_key</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set class properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_function</span><span class="p">(</span><span class="n">function</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.get_function"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.get_function">[docs]</a>    <span class="k">def</span> <span class="nf">get_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get function definition from AWS</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            See :func:`podpac.managers.aws.get_function`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_function</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">function</span></div>

<div class="viewcode-block" id="Lambda.validate_function"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.validate_function">[docs]</a>    <span class="k">def</span> <span class="nf">validate_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that function is configured properly</span>

<span class="sd">        This should only be run after running `self.get_function()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TOOD: implement</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Lambda.delete_function"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.delete_function">[docs]</a>    <span class="k">def</span> <span class="nf">delete_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove AWS Lambda function and associated resources on AWS</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_function</span><span class="p">()</span>

        <span class="n">delete_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>

        <span class="c1"># reset internals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_last_modified</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_code_sha256</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Lambda.add_trigger"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.add_trigger">[docs]</a>    <span class="k">def</span> <span class="nf">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement_id</span><span class="p">,</span> <span class="n">principle</span><span class="p">,</span> <span class="n">source_arn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add trigger (permission) to lambda function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        statement_id : str</span>
<span class="sd">            Specific identifier for trigger</span>
<span class="sd">        principle : str</span>
<span class="sd">            Principle identifier from AWS</span>
<span class="sd">        source_arn : str</span>
<span class="sd">            Source ARN for trigger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">add_function_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span> <span class="n">statement_id</span><span class="p">,</span> <span class="n">principle</span><span class="p">,</span> <span class="n">source_arn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_triggers</span><span class="p">[</span><span class="n">statement_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_arn</span></div>

<div class="viewcode-block" id="Lambda.remove_trigger"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.remove_trigger">[docs]</a>    <span class="k">def</span> <span class="nf">remove_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove trigger (permission) from lambda function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        statement_id : str</span>
<span class="sd">            Specific identifier for trigger</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">remove_function_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span> <span class="n">statement_id</span><span class="p">)</span>

        <span class="c1"># remove from local dict</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_triggers</span><span class="p">[</span><span class="n">statement_id</span><span class="p">]</span></div>

<div class="viewcode-block" id="Lambda.remove_triggers"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.remove_triggers">[docs]</a>    <span class="k">def</span> <span class="nf">remove_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all triggers from function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">triggers</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_triggers</span><span class="p">)</span>  <span class="c1"># to avoid changing the size of dict during iteration</span>
        <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="n">triggers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_trigger</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span></div>

    <span class="c1"># IAM Roles</span>
<div class="viewcode-block" id="Lambda.create_role"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.create_role">[docs]</a>    <span class="k">def</span> <span class="nf">create_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create IAM role to execute podpac lambda function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add special tag - value is hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_role_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span>

        <span class="n">role</span> <span class="o">=</span> <span class="n">create_role</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_role_description</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_role_policy_document</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_role_policy_arns</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_role_assume_policy_document</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_role_tags</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_role</span><span class="p">(</span><span class="n">role</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.get_role"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.get_role">[docs]</a>    <span class="k">def</span> <span class="nf">get_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get role definition from AWS</span>
<span class="sd">        </span>
<span class="sd">        See :attr:`self.function_role_name` for role_name</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            See :func:`podpac.managers.aws.get_role`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">get_role</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_role</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">role</span></div>

<div class="viewcode-block" id="Lambda.validate_role"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.validate_role">[docs]</a>    <span class="k">def</span> <span class="nf">validate_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that role will work with function.</span>

<span class="sd">        This should only be run after running `self.get_role()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: add constraints</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># check role policy document</span>
        <span class="n">document_valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">valid_document</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda.amazonaws.com&quot;</span><span class="p">},</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_role_assume_policy_document</span><span class="p">[</span><span class="s2">&quot;Statement&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">valid_document</span><span class="p">):</span>
                <span class="n">document_valid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">document_valid</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Function role policy document does not allow lambda function to assume role&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Lambda.delete_role"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.delete_role">[docs]</a>    <span class="k">def</span> <span class="nf">delete_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove role from AWS resources</span>

<span class="sd">        See :attr:`self.function_role_name` for role_name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_role</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No role name defined for this function&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">delete_role</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span><span class="p">)</span>

        <span class="c1"># reset members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_role_arn</span> <span class="o">=</span> <span class="kc">None</span></div>

        <span class="c1"># TODO: handle defaults after deletion</span>

    <span class="c1"># S3 Creation</span>
<div class="viewcode-block" id="Lambda.create_bucket"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.create_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">create_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create S3 bucket to work with function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Function name must be defined when creating S3 bucket and trigger&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lambda function must be created before creating a bucket&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_role_arn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function role must be created before creating a bucket&quot;</span><span class="p">)</span>

        <span class="c1"># add special tags - value is hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span>

        <span class="c1"># create bucket</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">create_bucket</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="n">bucket_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bucket_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_tags</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>

        <span class="c1"># after creating a bucket, you need to wait ~2 seconds before its active and can be uploaded to</span>
        <span class="c1"># this is not cool</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># get reference to s3 client for session</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

        <span class="c1"># add podpac deps to bucket for version</span>
        <span class="c1"># see if the function depedencies exist in bucket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_dependencies_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>

            <span class="c1"># copy from user supplied dependencies</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dependencies_zip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">put_object</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_dependencies_key</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_source_dependencies_zip</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># copy resources from podpac dist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s3resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>
                <span class="n">copy_source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_bucket</span><span class="p">,</span> <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_source_dependencies_key</span><span class="p">}</span>
                <span class="n">s3resource</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">copy_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_dependencies_key</span><span class="p">)</span>

        <span class="c1"># Add S3 Function triggers, if they don&#39;t exist already</span>
        <span class="c1"># TODO: add validition to see if trigger already exists</span>
        <span class="k">if</span> <span class="s2">&quot;S3&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">:</span>
            <span class="c1"># add permission to invoke call lambda - this feels brittle due to source_arn</span>
            <span class="n">statement_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[-_.]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">)</span>
            <span class="n">principle</span> <span class="o">=</span> <span class="s2">&quot;s3.amazonaws.com&quot;</span>
            <span class="n">source_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:s3:::</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">statement_id</span><span class="p">,</span> <span class="n">principle</span><span class="p">,</span> <span class="n">source_arn</span><span class="p">)</span>

            <span class="c1"># lambda integration on object creation events</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">put_bucket_notification_configuration</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span>
                <span class="n">NotificationConfiguration</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;LambdaFunctionConfigurations&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span>
                            <span class="s2">&quot;LambdaFunctionArn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span><span class="p">,</span>
                            <span class="s2">&quot;Events&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;s3:ObjectCreated:*&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;Filter&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;FilterRules&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_input</span><span class="p">}]}},</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping S3 trigger because &#39;S3&#39; not in the function triggers&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bucket</span></div>

<div class="viewcode-block" id="Lambda.get_bucket"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.get_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get S3 Bucket for function</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            See :func:`podpac.managers.aws.get_bucket`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bucket</span></div>

<div class="viewcode-block" id="Lambda.validate_bucket"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.validate_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">validate_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that bucket will work with function.</span>

<span class="sd">        This should only be run after running `self.get_bucket()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bucket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">s3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

        <span class="c1"># make sure dependencies are in there</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_dependencies_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to find PODPAC dependencies in bucket&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># TODO: make sure trigger exists</span>
        <span class="k">if</span> <span class="s2">&quot;S3&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Lambda.delete_bucket"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.delete_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">delete_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete_objects</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete bucket associated with this function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delete_objects : bool, optional</span>
<span class="sd">            Delete all objects in the bucket while deleting bucket. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>

        <span class="c1"># delete bucket</span>
        <span class="n">delete_bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="n">delete_objects</span><span class="o">=</span><span class="n">delete_objects</span><span class="p">)</span>

        <span class="c1"># TODO: update manage attributes here?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bucket</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># API Gateway</span>
<div class="viewcode-block" id="Lambda.create_api"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.create_api">[docs]</a>    <span class="k">def</span> <span class="nf">create_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create API Gateway API for lambda function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;APIGateway&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping API creation because &#39;APIGateway&#39; not in the function triggers&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Function name must be defined when creating API Gateway&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lambda function must be created before creating an API bucket&quot;</span><span class="p">)</span>

        <span class="c1"># add special tag - value is hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_api_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span>

        <span class="c1"># create api and resource</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">create_api</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_api_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_api_description</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_api_version</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_api_tags</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_api_endpoint</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_api</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>

        <span class="c1"># lambda proxy integration - this feels pretty brittle due to uri</span>
        <span class="c1"># https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/apigateway.html#APIGateway.Client.put_integration</span>
        <span class="n">aws_lambda_uri</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:apigateway:</span><span class="si">{}</span><span class="s2">:lambda:path/2015-03-31/functions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">region_name</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/invocations&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aws_lambda_uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span><span class="p">)</span>

        <span class="n">apigateway</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;apigateway&quot;</span><span class="p">)</span>
        <span class="n">apigateway</span><span class="o">.</span><span class="n">put_integration</span><span class="p">(</span>
            <span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="n">resourceId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="n">httpMethod</span><span class="o">=</span><span class="s2">&quot;ANY&quot;</span><span class="p">,</span>
            <span class="n">integrationHttpMethod</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;AWS_PROXY&quot;</span><span class="p">,</span>
            <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span>
            <span class="n">passthroughBehavior</span><span class="o">=</span><span class="s2">&quot;WHEN_NO_MATCH&quot;</span><span class="p">,</span>
            <span class="n">contentHandling</span><span class="o">=</span><span class="s2">&quot;CONVERT_TO_TEXT&quot;</span><span class="p">,</span>
            <span class="n">timeoutInMillis</span><span class="o">=</span><span class="mi">29000</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># get responses back</span>
        <span class="n">apigateway</span><span class="o">.</span><span class="n">put_integration_response</span><span class="p">(</span>
            <span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="n">resourceId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="n">httpMethod</span><span class="o">=</span><span class="s2">&quot;ANY&quot;</span><span class="p">,</span>
            <span class="n">statusCode</span><span class="o">=</span><span class="s2">&quot;200&quot;</span><span class="p">,</span>
            <span class="n">selectionPattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># bug, see https://github.com/aws/aws-sdk-ruby/issues/1080</span>
        <span class="p">)</span>

        <span class="c1"># deploy the api. this has to happen after creating the integration</span>
        <span class="n">deploy_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_stage</span><span class="p">)</span>

        <span class="c1"># add permission to invoke call lambda - this feels brittle due to source_arn</span>
        <span class="n">statement_id</span> <span class="o">=</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">principle</span> <span class="o">=</span> <span class="s2">&quot;apigateway.amazonaws.com&quot;</span>
        <span class="n">source_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:execute-api:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">/*/*/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_account_id</span><span class="p">(),</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">statement_id</span><span class="p">,</span> <span class="n">principle</span><span class="p">,</span> <span class="n">source_arn</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.get_api"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.get_api">[docs]</a>    <span class="k">def</span> <span class="nf">get_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get API Gateway definition for function</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            See :func:`podpac.managers.aws.get_api`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;APIGateway&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping API get because &#39;APIGateway&#39; not in the function triggers&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">get_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_endpoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_api</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span></div>

<div class="viewcode-block" id="Lambda.validate_api"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.validate_api">[docs]</a>    <span class="k">def</span> <span class="nf">validate_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that API will work with function.</span>

<span class="sd">        This should only be run after running `self.get_api()`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;APIGateway&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping API validation because &#39;APIGateway&#39; not in the function triggers&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># TOOD: implement</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Lambda.delete_api"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.delete_api">[docs]</a>    <span class="k">def</span> <span class="nf">delete_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete API Gateway for Function&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>

        <span class="c1"># remove API</span>
        <span class="n">delete_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_name</span><span class="p">)</span>

        <span class="c1"># reset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_resource_id</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># Function budget</span>
<div class="viewcode-block" id="Lambda.create_budget"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.create_budget">[docs]</a>    <span class="k">def</span> <span class="nf">create_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create budget for lambda function based on node hash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">create_budget</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_budget_amount</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_budget_email</span><span class="p">,</span>
            <span class="n">budget_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_budget_name</span><span class="p">,</span>
            <span class="n">budget_currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_budget_currency</span><span class="p">,</span>
            <span class="n">budget_filter_tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_podpac_resource_hash&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_budget</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span></div>

<div class="viewcode-block" id="Lambda.get_budget"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.get_budget">[docs]</a>    <span class="k">def</span> <span class="nf">get_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get budget definition for function</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            See :func:`podpac.managers.aws.get_budget`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">get_budget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_budget_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_budget</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">budget</span></div>

<div class="viewcode-block" id="Lambda.validate_budget"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.validate_budget">[docs]</a>    <span class="k">def</span> <span class="nf">validate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate budget definition for function</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            See :func:`podpac.managers.aws.get_budget`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_budget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Lambda.delete_budget"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.delete_budget">[docs]</a>    <span class="k">def</span> <span class="nf">delete_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete budget associated with function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_budget</span><span class="p">()</span>

        <span class="c1"># delete budget</span>
        <span class="n">delete_budget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_budget_name</span><span class="p">)</span>

        <span class="c1"># reset class attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_budget</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># Logs</span>
<div class="viewcode-block" id="Lambda.get_logs"><a class="viewcode-back" href="../../../../user/api/podpac.managers.Lambda.html#podpac.managers.Lambda.get_logs">[docs]</a>    <span class="k">def</span> <span class="nf">get_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get Cloudwatch logs from lambda function execution</span>
<span class="sd">        </span>
<span class="sd">        See :func:`podpac.managers.aws.get_logs`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        limit : int, optional</span>
<span class="sd">            Limit logs to the most recent N logs</span>
<span class="sd">        start : str, optional</span>
<span class="sd">            Datetime string. Must work as input to np.datetime64 (i.e np.datetime64(start))</span>
<span class="sd">            Defaults to 1 hour prior to ``end``.</span>
<span class="sd">        end : str, optional</span>
<span class="sd">            Datetime string. Must work as input to np.datetime64 (i.e np.datetime64(end))</span>
<span class="sd">            Defaults to now.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of log events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Function name must be defined to get logs&quot;</span><span class="p">)</span>

        <span class="n">log_group_name</span> <span class="o">=</span> <span class="s2">&quot;/aws/lambda/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">log_group_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span></div>

    <span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Internals</span>
    <span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_set_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set function class members</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        function : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update all class members with return</span>
        <span class="c1"># this allows a new Lambda instance to fill in class members from input function_name</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_handler&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;Handler&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_description&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;Description&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_env_variables&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;Environment&quot;</span><span class="p">][</span><span class="s2">&quot;Variables&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_timeout&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;Timeout&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_memory&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;MemorySize&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_tags&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_arn</span> <span class="o">=</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;FunctionArn&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_last_modified</span> <span class="o">=</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_version</span> <span class="o">=</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_code_sha256</span> <span class="o">=</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span>
                <span class="s2">&quot;CodeSha256&quot;</span>
            <span class="p">]</span>  <span class="c1"># TODO: is this the best way to determine S3 source bucket and dist zip?</span>

            <span class="c1"># store a copy of the whole response from AWS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="n">function</span>

    <span class="k">def</span> <span class="nf">_set_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set role class members</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        role : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_role_name&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;RoleName&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_role_description&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_role_assume_policy_document&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;AssumeRolePolicyDocument&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_role_policy_arns&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;policy_arns&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_role_policy_document&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;policy_document&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_role_tags&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_role_arn</span> <span class="o">=</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span>

            <span class="c1"># store a copy of the whole response from AWS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="n">role</span>

    <span class="k">def</span> <span class="nf">_set_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set bucket class members</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bucket : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_s3_bucket&quot;</span><span class="p">,</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_s3_tags&quot;</span><span class="p">,</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">])</span>

            <span class="c1"># store a copy of the whole response from AWS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bucket</span> <span class="o">=</span> <span class="n">bucket</span>

    <span class="k">def</span> <span class="nf">_set_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set api class members</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        api : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">api</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_api_name&quot;</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_api_description&quot;</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_api_version&quot;</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_api_tags&quot;</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_id</span> <span class="o">=</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;stage&quot;</span> <span class="ow">in</span> <span class="n">api</span> <span class="ow">and</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_api_stage&quot;</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s2">&quot;resource&quot;</span> <span class="ow">in</span> <span class="n">api</span> <span class="ow">and</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_resource_id</span> <span class="o">=</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_api_endpoint&quot;</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;pathPart&quot;</span><span class="p">])</span>

            <span class="c1"># set api url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_api_url</span><span class="p">()</span>

            <span class="c1"># store a copy of the whole response from AWS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="n">api</span>

    <span class="k">def</span> <span class="nf">_set_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">budget</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set budget class members</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        budget : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">budget_filter_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_podpac_resource_hash&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_budget_amount&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">budget</span><span class="p">[</span><span class="s2">&quot;BudgetLimit&quot;</span><span class="p">][</span><span class="s2">&quot;Amount&quot;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_budget_name&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">[</span><span class="s2">&quot;BudgetName&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s2">&quot;function_budget_currency&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="p">[</span><span class="s2">&quot;BudgetLimit&quot;</span><span class="p">][</span><span class="s2">&quot;Unit&quot;</span><span class="p">])</span>

            <span class="c1"># TODO</span>
            <span class="c1"># self.set_trait(&quot;function_budget_email&quot;, budget[&quot;BudgetLimit&quot;][&quot;Amount&quot;]))</span>

            <span class="c1"># store a copy of the whole response from AWS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_budget</span> <span class="o">=</span> <span class="n">budget</span>

    <span class="k">def</span> <span class="nf">_create_eval_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;shorthand to create pipeline on eval&quot;&quot;&quot;</span>

        <span class="c1"># add coordinates to the pipeline</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span>  <span class="c1"># contains &quot;pipeline&quot; and &quot;output&quot; keys</span>
        <span class="n">pipeline</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>

        <span class="c1"># TODO: should we move this to `self.pipeline`?</span>
        <span class="n">pipeline</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_settings</span>
        <span class="n">pipeline</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span>
            <span class="s2">&quot;FUNCTION_DEPENDENCIES_KEY&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_dependencies_key</span>  <span class="c1"># overwrite in case this is specified explicitly by class</span>

        <span class="k">return</span> <span class="n">pipeline</span>

    <span class="k">def</span> <span class="nf">_eval_invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;eval node through invoke trigger&quot;&quot;&quot;</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Evaluating pipeline via invoke&quot;</span><span class="p">)</span>

        <span class="c1"># create eval pipeline</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_eval_pipeline</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>

        <span class="c1"># create lambda client</span>
        <span class="n">awslambda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>

        <span class="c1"># invoke</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">JSONEncoder</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">awslambda</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">FunctionName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">LogType</span><span class="o">=</span><span class="s2">&quot;Tail&quot;</span><span class="p">,</span>  <span class="c1"># include the execution log in the response.</span>
            <span class="n">Payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received response from lambda function&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;FunctionError&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unhandled error from lambda function&quot;</span><span class="p">)</span>
            <span class="c1"># logs = base64.b64decode(response[&quot;LogResult&quot;]).decode(&quot;UTF-8&quot;).split(&#39;\n&#39;)</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Payload&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">LambdaException</span><span class="p">(</span>
                <span class="s2">&quot;Error in lambda function evaluation:</span><span class="se">\n\n</span><span class="s2">Error Type: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Error Message: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Stack Trace: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;errorType&quot;</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;errorMessage&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;stackTrace&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># After waiting, load the pickle file like this:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Payload&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="n">UnitsDataArray</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span>

    <span class="k">def</span> <span class="nf">_eval_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate node through s3 trigger&quot;&quot;&quot;</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Evaluating pipeline via S3&quot;</span><span class="p">)</span>

        <span class="n">input_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_input</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_input</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_output</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_s3_output</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># create eval pipeline</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_eval_pipeline</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="n">pipeline</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span><span class="s2">&quot;FUNCTION_FORCE_COMPUTE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_compute</span>
        <span class="n">pipeline</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span>
            <span class="s2">&quot;FUNCTION_S3_INPUT&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">input_folder</span>  <span class="c1"># overwrite in case this is specified explicitly by class</span>
        <span class="n">pipeline</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span>
            <span class="s2">&quot;FUNCTION_S3_OUTPUT&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">output_folder</span>  <span class="c1"># overwrite in case this is specified explicitly by class</span>

        <span class="c1"># filename</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{folder}{output}</span><span class="s2">_</span><span class="si">{source}</span><span class="s2">_</span><span class="si">{coordinates}</span><span class="s2">.</span><span class="si">{suffix}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">input_folder</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_output_name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># create s3 client</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

        <span class="c1"># put pipeline into s3 bucket</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
            <span class="n">Body</span><span class="o">=</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">JSONEncoder</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))),</span>
            <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span>
            <span class="n">Key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully put pipeline into S3 bucket&quot;</span><span class="p">)</span>

        <span class="c1"># wait for object to exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_result</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># TODO: handle the &quot;force_compute&quot; parameter</span>
        <span class="n">waiter</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s2">&quot;object_exists&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{folder}{output}</span><span class="s2">_</span><span class="si">{source}</span><span class="s2">_</span><span class="si">{coordinates}</span><span class="s2">.</span><span class="si">{suffix}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_output_name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_output_format</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting to wait for output&quot;</span><span class="p">)</span>
        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># After waiting, load the pickle file like this:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received response from lambda function&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="n">UnitsDataArray</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span>

    <span class="k">def</span> <span class="nf">_eval_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: implement and pass in settings in the REST API</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generated API url</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;https://</span><span class="si">{}</span><span class="s2">.execute-api.</span><span class="si">{}</span><span class="s2">.amazonaws.com/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_function_api_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_api_endpoint</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="s2">&quot;(staged)&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_valid</span> <span class="k">else</span> <span class="s2">&quot;(built)&quot;</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Name: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Source: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Bucket: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_s3_bucket</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Triggers: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Role: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_role_name</span><span class="p">)</span>

        <span class="c1"># Bucket</span>

        <span class="c1"># API</span>
        <span class="k">if</span> <span class="s2">&quot;APIGateway&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_triggers</span><span class="p">:</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">API: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_api_name</span><span class="p">)</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">API Url: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_api_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rep</span></div>


<span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for :class:`boto3.Session`</span>
<span class="sd">    See https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html</span>

<span class="sd">    We wrap the Session class to provide access to the podpac settings for the</span>
<span class="sd">    aws_access_key_id, aws_secret_access_key, and region_name and to check the credentials</span>
<span class="sd">    on session creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aws_access_key_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">aws_access_key_id</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aws_access_key_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">aws_access_key_id</span>
        <span class="n">aws_secret_access_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aws_secret_access_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">aws_secret_access_key</span>
        <span class="p">)</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;AWS_REGION_NAME&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">region_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">region_name</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Session</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">aws_access_key_id</span><span class="p">,</span> <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">aws_secret_access_key</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_id</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;AWS credential check failed. Confirm aws access key id and aws secred access key are valid. Credential check exception: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;AWS credential check failed. Confirm aws access key id and aws secred access key are valid.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_account_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the account ID assciated with this AWS session. The credentials will determine the account ID.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            account id associated with credentials</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()[</span><span class="s2">&quot;Account&quot;</span><span class="p">]</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># S3</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">create_bucket</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">bucket_region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bucket_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bucket_tags</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Create S3 bucket</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    bucket_name : str</span>
<span class="sd">        Bucket name</span>
<span class="sd">    bucket_region : str, optional</span>
<span class="sd">        Location constraint for bucket. Defaults to no location constraint</span>
<span class="sd">    bucket_policy : dict, optional</span>
<span class="sd">        Bucket policy document as dict. For parameters, see https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutBucketPolicy.html#API_PutBucketPolicy_RequestSyntax </span>
<span class="sd">    bucket_tags : dict, optional</span>
<span class="sd">        Bucket tags</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        See :func:`podpac.managers.aws.get_bucket`</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Description</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bucket</span> <span class="o">=</span> <span class="n">get_bucket</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>

    <span class="c1"># TODO: add checks to make sure bucket parameters match</span>
    <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S3 bucket &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Using existing bucket.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bucket</span>

    <span class="k">if</span> <span class="n">bucket_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`bucket_name` is None in create_bucket&quot;</span><span class="p">)</span>

    <span class="c1"># add special podpac tags for billing id</span>
    <span class="n">bucket_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

    <span class="c1"># bucket configuration</span>
    <span class="n">bucket_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ACL&quot;</span><span class="p">:</span> <span class="s2">&quot;private&quot;</span><span class="p">,</span> <span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">bucket_name</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">bucket_region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bucket_config</span><span class="p">[</span><span class="s2">&quot;LocationConstraint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket_region</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating S3 bucket </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

    <span class="c1"># create bucket</span>
    <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="o">**</span><span class="n">bucket_config</span><span class="p">)</span>

    <span class="c1"># add tags</span>
    <span class="c1"># for some reason the tags API is different here</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bucket_tags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">bucket_tags</span><span class="p">[</span><span class="n">key</span><span class="p">]})</span>

    <span class="n">s3</span><span class="o">.</span><span class="n">put_bucket_tagging</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Tagging</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TagSet&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">})</span>

    <span class="c1"># set bucket policy</span>
    <span class="k">if</span> <span class="n">bucket_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">put_bucket_policy</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Policy</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bucket_policy</span><span class="p">))</span>

    <span class="c1"># get finalized bucket</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">get_bucket</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully created S3 bucket &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bucket</span>


<span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">bucket_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an object from an S3 bucket</span>
<span class="sd">    </span>
<span class="sd">    See https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.get_object</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    bucket_name : str</span>
<span class="sd">        Bucket name</span>
<span class="sd">    bucket_path : str</span>
<span class="sd">        Path to object in bucket</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">bucket_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bucket_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting object </span><span class="si">{}</span><span class="s2"> from S3 bucket </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_path</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">))</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

    <span class="c1"># see if the object exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># get the object</span>
    <span class="k">return</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">put_object</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">bucket_path</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">object_acl</span><span class="o">=</span><span class="s2">&quot;private&quot;</span><span class="p">,</span> <span class="n">object_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple wrapper to put an object in an S3 bucket</span>
<span class="sd">    </span>
<span class="sd">    See https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.put_object</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    bucket_name : str</span>
<span class="sd">        Bucket name</span>
<span class="sd">    bucket_path : str</span>
<span class="sd">        Path in bucket to put object</span>
<span class="sd">    file : str | bytes, optional</span>
<span class="sd">        Path to local object or b&#39;bytes&#39;. If none, this will create a directory in bucket.</span>
<span class="sd">    object_acl : str, optional</span>
<span class="sd">        Object ACL. Defaults to &#39;private&#39;</span>
<span class="sd">        One of: &#39;private&#39;|&#39;public-read&#39;|&#39;public-read-write&#39;|&#39;authenticated-read&#39;|&#39;aws-exec-read&#39;|&#39;bucket-owner-read&#39;|&#39;bucket-owner-full-control&#39;</span>
<span class="sd">    object_metadata : dict, optional</span>
<span class="sd">        Metadata to add to object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">bucket_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bucket_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Putting object </span><span class="si">{}</span><span class="s2"> into S3 bucket </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_path</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">))</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

    <span class="n">object_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ACL&quot;</span><span class="p">:</span> <span class="n">object_acl</span><span class="p">,</span> <span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">bucket_path</span><span class="p">}</span>

    <span class="n">object_body</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">object_body</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">object_body</span> <span class="o">=</span> <span class="n">file</span>

    <span class="k">if</span> <span class="n">object_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">object_config</span><span class="p">[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_body</span>

    <span class="k">if</span> <span class="n">object_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">object_config</span><span class="p">[</span><span class="s2">&quot;Metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_metadata</span>

    <span class="n">s3</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="o">**</span><span class="n">object_config</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get S3 bucket parameters</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    bucket_name : str</span>
<span class="sd">        Bucket name</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Bucket dict containing keys: &quot;name&quot;, region&quot;, &quot;policy&quot;, &quot;tags&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bucket_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting S3 bucket </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

    <span class="c1"># see if the bucket exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">head_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># init empty object</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">bucket_name</span><span class="p">}</span>

    <span class="c1"># TODO: this is usually none, even though the bucket has a region. It could either be a bug</span>
    <span class="c1"># in getting the region/LocationConstraint, or just misleading</span>
    <span class="c1"># get location constraint. this will be None for no location constraint</span>
    <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_bucket_location</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)[</span><span class="s2">&quot;LocationConstraint&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_bucket_policy</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)[</span><span class="s2">&quot;Policy&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># reverse tags into dict</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tag_set</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_bucket_tagging</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)[</span><span class="s2">&quot;TagSet&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_set</span><span class="p">:</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span>

    <span class="k">return</span> <span class="n">bucket</span>


<span class="k">def</span> <span class="nf">delete_bucket</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">delete_objects</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove S3 bucket from AWS resources</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    bucket_name : str</span>
<span class="sd">        Bucket name to delete</span>
<span class="sd">    delete_objects : bool, optional</span>
<span class="sd">        Must be set to True if the bucket contains files. This helps avoid deleting buckets inadvertantly    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bucket_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`bucket_name` not defined in delete_bucket&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># make sure bucket exists</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">get_bucket</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S3 bucket &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing S3 bucket &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

    <span class="c1"># need to remove all objects before it can be removed. Only do this if delete_objects is TRue</span>
    <span class="k">if</span> <span class="n">delete_objects</span><span class="p">:</span>
        <span class="n">s3resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3resource</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">bucket</span><span class="o">.</span><span class="n">object_versions</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># delete objects that are versioned</span>
        <span class="n">bucket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># delete objects that are not versioned</span>

    <span class="c1"># now delete bucket</span>
    <span class="n">s3</span><span class="o">.</span><span class="n">delete_bucket</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully removed S3 bucket &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">))</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Lambda</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">create_function</span><span class="p">(</span>
    <span class="n">session</span><span class="p">,</span>
    <span class="n">function_name</span><span class="p">,</span>
    <span class="n">function_role_arn</span><span class="p">,</span>
    <span class="n">function_handler</span><span class="p">,</span>
    <span class="n">function_description</span><span class="o">=</span><span class="s2">&quot;PODPAC function&quot;</span><span class="p">,</span>
    <span class="n">function_timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="n">function_memory</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
    <span class="n">function_env_variables</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">function_tags</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">function_source_dist_zip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">function_source_bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">function_source_dist_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build Lambda function and associated resources on AWS</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    function_name : str</span>
<span class="sd">        Function name</span>
<span class="sd">    function_role_arn : str</span>
<span class="sd">        Role ARN for the function.</span>
<span class="sd">        Generate a role for lambda function execution with :func:`podpac.managers.aws.create_role`.</span>
<span class="sd">        The &quot;Arn&quot; key in the output of this function can be used and this input.</span>
<span class="sd">    function_handler : str</span>
<span class="sd">        Handler module and method (i.e. &quot;module.method&quot;)</span>
<span class="sd">    function_description : str, optional</span>
<span class="sd">        Function description</span>
<span class="sd">    function_timeout : int, optional</span>
<span class="sd">        Function timeout</span>
<span class="sd">    function_memory : int, optional</span>
<span class="sd">        Function memory limit</span>
<span class="sd">    function_env_variables : dict, optional</span>
<span class="sd">        Environment variables for function</span>
<span class="sd">    function_tags : dict, optional</span>
<span class="sd">        Function tags</span>
<span class="sd">    function_source_dist_zip : str, optional</span>
<span class="sd">        Path to .zip archive containg the function source.</span>
<span class="sd">    function_source_bucket : str</span>
<span class="sd">        S3 Bucket containing .zip archive of the function source. If defined, :attr:`function_source_dist_key` must be defined.</span>
<span class="sd">    function_source_dist_key : str</span>
<span class="sd">        If :attr:`function_source_bucket` is defined, this is the path to the .zip archive of the function source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        See :func:`podpac.managers.aws.get_function`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">function</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>

    <span class="c1"># TODO: add checks to make sure role parameters match</span>
    <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;AWS lambda function &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Using existing function.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">function</span>

    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`function_name` is None in create_function&quot;</span><span class="p">)</span>

    <span class="c1"># add special podpac tags for billing id</span>
    <span class="n">function_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating lambda function </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
    <span class="n">awslambda</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>

    <span class="n">lambda_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Runtime&quot;</span><span class="p">:</span> <span class="s2">&quot;python3.7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FunctionName&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
        <span class="s2">&quot;Publish&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Role&quot;</span><span class="p">:</span> <span class="n">function_role_arn</span><span class="p">,</span>
        <span class="s2">&quot;Handler&quot;</span><span class="p">:</span> <span class="n">function_handler</span><span class="p">,</span>
        <span class="s2">&quot;Code&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="n">function_description</span><span class="p">,</span>
        <span class="s2">&quot;Timeout&quot;</span><span class="p">:</span> <span class="n">function_timeout</span><span class="p">,</span>
        <span class="s2">&quot;MemorySize&quot;</span><span class="p">:</span> <span class="n">function_memory</span><span class="p">,</span>
        <span class="s2">&quot;Environment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Variables&quot;</span><span class="p">:</span> <span class="n">function_env_variables</span><span class="p">},</span>
        <span class="s2">&quot;Tags&quot;</span><span class="p">:</span> <span class="n">function_tags</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># read function from zip file</span>
    <span class="k">if</span> <span class="n">function_source_dist_zip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Supplying a source dist zip from a local file is not yet supported&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: this fails when the file size is over a certain limit</span>
        <span class="c1"># with open(function_source_dist_zip, &quot;rb&quot;) as f:</span>
        <span class="c1">#     lambda_config[&quot;Code&quot;][&quot;ZipFile&quot;] = f.read()</span>

    <span class="c1"># read function from S3 (Default)</span>
    <span class="k">elif</span> <span class="n">function_source_bucket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">function_source_dist_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lambda_config</span><span class="p">[</span><span class="s2">&quot;Code&quot;</span><span class="p">][</span><span class="s2">&quot;S3Bucket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_source_bucket</span>
        <span class="n">lambda_config</span><span class="p">[</span><span class="s2">&quot;Code&quot;</span><span class="p">][</span><span class="s2">&quot;S3Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_source_dist_key</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function source is not defined&quot;</span><span class="p">)</span>

    <span class="c1"># create function</span>
    <span class="n">awslambda</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="o">**</span><span class="n">lambda_config</span><span class="p">)</span>

    <span class="c1"># get function after created</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully created lambda function &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">function</span>


<span class="k">def</span> <span class="nf">get_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get function definition from AWS</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function_name : str</span>
<span class="sd">        Function name</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dict returned from Boto3 get_function</span>
<span class="sd">        Based on value returned by https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/lambda.html#Lambda.Client.get_function</span>
<span class="sd">        Adds &quot;tags&quot; key to list function tags</span>
<span class="sd">        Returns None if no function role is found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting lambda function </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>

    <span class="n">awslambda</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">awslambda</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">FunctionName</span><span class="o">=</span><span class="n">function_name</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;ResponseMetadata&quot;</span><span class="p">]</span>  <span class="c1"># remove response details from function</span>
    <span class="k">except</span> <span class="n">awslambda</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceNotFoundException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to get lambda function </span><span class="si">{}</span><span class="s2"> with exception: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># get tags</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">function</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">awslambda</span><span class="o">.</span><span class="n">list_tags</span><span class="p">(</span><span class="n">Resource</span><span class="o">=</span><span class="n">function</span><span class="p">[</span><span class="s2">&quot;Configuration&quot;</span><span class="p">][</span><span class="s2">&quot;FunctionArn&quot;</span><span class="p">])[</span><span class="s2">&quot;Tags&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="n">function</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="n">function</span>


<span class="k">def</span> <span class="nf">update_function</span><span class="p">(</span>
    <span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_source_dist_zip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">function_source_bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">function_source_dist_key</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update function on AWS</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    function_name : str</span>
<span class="sd">        Function name</span>
<span class="sd">    function_source_dist_zip : str, optional</span>
<span class="sd">        Path to .zip archive containg the function source.</span>
<span class="sd">    function_source_bucket : str</span>
<span class="sd">        S3 Bucket containing .zip archive of the function source. If defined, :attr:`function_source_dist_key` must be defined.</span>
<span class="sd">    function_source_dist_key : str</span>
<span class="sd">        If :attr:`function_source_bucket` is defined, this is the path to the .zip archive of the function source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        See :func:`podpac.managers.aws.get_function`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;AWS lambda function </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating lambda function </span><span class="si">{}</span><span class="s2"> code&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
    <span class="n">awslambda</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>

    <span class="n">lambda_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;FunctionName&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span> <span class="s2">&quot;Publish&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="c1"># read function from S3 (Default)</span>
    <span class="k">if</span> <span class="n">function_source_bucket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">function_source_dist_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lambda_config</span><span class="p">[</span><span class="s2">&quot;S3Bucket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_source_bucket</span>
        <span class="n">lambda_config</span><span class="p">[</span><span class="s2">&quot;S3Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_source_dist_key</span>

    <span class="c1"># read function from zip file</span>
    <span class="k">elif</span> <span class="n">function_source_dist_zip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Supplying a source dist zip from a local file is not yet supported&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: this fails when the file size is over a certain limit</span>
        <span class="c1"># with open(function_source_dist_zip, &quot;rb&quot;) as f:</span>
        <span class="c1">#     lambda_config[&quot;ZipFile&quot;] = f.read()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function source is not defined&quot;</span><span class="p">)</span>

    <span class="c1"># create function</span>
    <span class="n">awslambda</span><span class="o">.</span><span class="n">update_function_code</span><span class="p">(</span><span class="o">**</span><span class="n">lambda_config</span><span class="p">)</span>

    <span class="c1"># get function after created</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully updated lambda function code &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">function</span>


<span class="k">def</span> <span class="nf">delete_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove AWS Lambda function</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    function_name : str</span>
<span class="sd">        Lambda function name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`function_name` not defined in delete_function&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># make sure function exists</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Lambda function &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing lambda function &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>

    <span class="n">awslambda</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
    <span class="n">awslambda</span><span class="o">.</span><span class="n">delete_function</span><span class="p">(</span><span class="n">FunctionName</span><span class="o">=</span><span class="n">function_name</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removed lambda function &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">add_function_trigger</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">statement_id</span><span class="p">,</span> <span class="n">principle</span><span class="p">,</span> <span class="n">source_arn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add trigger (permission) to lambda function</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    function_name : str</span>
<span class="sd">        Function name</span>
<span class="sd">    statement_id : str</span>
<span class="sd">        Specific identifier for trigger</span>
<span class="sd">    principle : str</span>
<span class="sd">        Principle identifier from AWS</span>
<span class="sd">    source_arn : str</span>
<span class="sd">        Source ARN for trigger</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">statement_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">principle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">source_arn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;`function_name`, `statement_id`, `principle`, and `source_arn` are required to add function trigger&quot;</span>
        <span class="p">)</span>

    <span class="n">awslambda</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
    <span class="n">awslambda</span><span class="o">.</span><span class="n">add_permission</span><span class="p">(</span>
        <span class="n">FunctionName</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
        <span class="n">StatementId</span><span class="o">=</span><span class="n">statement_id</span><span class="p">,</span>
        <span class="n">Action</span><span class="o">=</span><span class="s2">&quot;lambda:InvokeFunction&quot;</span><span class="p">,</span>
        <span class="n">Principal</span><span class="o">=</span><span class="n">principle</span><span class="p">,</span>
        <span class="n">SourceArn</span><span class="o">=</span><span class="n">source_arn</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">remove_function_trigger</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">statement_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove trigger (permission) from lambda function</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    function_name : str</span>
<span class="sd">        Function name</span>
<span class="sd">    statement_id : str</span>
<span class="sd">        Specific identifier for trigger</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">statement_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`api_id` or `statement_id` not defined in remove_function_trigger&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">awslambda</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">awslambda</span><span class="o">.</span><span class="n">remove_permission</span><span class="p">(</span><span class="n">FunctionName</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span> <span class="n">StatementId</span><span class="o">=</span><span class="n">statement_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">awslambda</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceNotFoundException</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to remove permission </span><span class="si">{}</span><span class="s2"> on function </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statement_id</span><span class="p">,</span> <span class="n">function_name</span><span class="p">))</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># IAM Roles</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">create_role</span><span class="p">(</span>
    <span class="n">session</span><span class="p">,</span>
    <span class="n">role_name</span><span class="p">,</span>
    <span class="n">role_description</span><span class="o">=</span><span class="s2">&quot;PODPAC Role&quot;</span><span class="p">,</span>
    <span class="n">role_policy_document</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">role_policy_arns</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">role_assume_policy_document</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">role_tags</span><span class="o">=</span><span class="p">{},</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create IAM role</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    role_name : str</span>
<span class="sd">        Role name to create</span>
<span class="sd">    role_description : str, optional</span>
<span class="sd">        Role description</span>
<span class="sd">    role_policy_document : dict, optional</span>
<span class="sd">        Role policy document allowing role access to AWS resources</span>
<span class="sd">        See https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/iam.html#IAM.Client.put_role</span>
<span class="sd">    role_policy_arns : list, optional</span>
<span class="sd">        List of role policy ARN&#39;s to attach to role</span>
<span class="sd">    role_assume_policy_document : None, optional</span>
<span class="sd">        Role policy document. </span>
<span class="sd">        Defaults to trust policy allowing role to execute lambda functions.</span>
<span class="sd">        See https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/iam.html#IAM.Client.create_role</span>
<span class="sd">    role_tags : dict, optional</span>
<span class="sd">        Role tags</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        See :func:`podpac.managers.aws.get_role`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">role</span> <span class="o">=</span> <span class="n">get_role</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">role_name</span><span class="p">)</span>

    <span class="c1"># TODO: add checks to make sure role parameters match</span>
    <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;IAM role &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Using existing role.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">role</span>

    <span class="k">if</span> <span class="n">role_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`role_name` is None in create_role&quot;</span><span class="p">)</span>

    <span class="c1"># default role_assume_policy_document is lambda</span>
    <span class="k">if</span> <span class="n">role_assume_policy_document</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">role_assume_policy_document</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span> <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;lambda.amazonaws.com&quot;</span><span class="p">},</span> <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span><span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>

    <span class="c1"># add special podpac tags for billing id</span>
    <span class="n">role_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating IAM role </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>
    <span class="n">iam</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">)</span>

    <span class="n">iam_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;RoleName&quot;</span><span class="p">:</span> <span class="n">role_name</span><span class="p">,</span>
        <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="n">role_description</span><span class="p">,</span>
        <span class="s2">&quot;AssumeRolePolicyDocument&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">role_assume_policy_document</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># for some reason the tags API is different here</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">role_tags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">role_tags</span><span class="p">[</span><span class="n">key</span><span class="p">]})</span>
    <span class="n">iam_config</span><span class="p">[</span><span class="s2">&quot;Tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span>

    <span class="c1"># create role</span>
    <span class="n">iam</span><span class="o">.</span><span class="n">create_role</span><span class="p">(</span><span class="o">**</span><span class="n">iam_config</span><span class="p">)</span>

    <span class="c1"># add role policy document</span>
    <span class="k">if</span> <span class="n">role_policy_document</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-policy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">iam</span><span class="o">.</span><span class="n">put_role_policy</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">PolicyName</span><span class="o">=</span><span class="n">policy_name</span><span class="p">,</span> <span class="n">PolicyDocument</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">role_policy_document</span><span class="p">))</span>

    <span class="c1"># attached role polcy ARNs</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">role_policy_arns</span><span class="p">:</span>
        <span class="n">iam</span><span class="o">.</span><span class="n">attach_role_policy</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">PolicyArn</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>

    <span class="c1"># get finalized role</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">get_role</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">role_name</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully created IAM role &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">role</span>


<span class="k">def</span> <span class="nf">get_role</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">role_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get role definition from AWS</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    role_name : str</span>
<span class="sd">        Role name</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dict returned from AWS defining role.</span>
<span class="sd">        Based on the &#39;Role&#39; key in https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/iam.html#IAM.Client.get_role</span>
<span class="sd">        Adds &quot;policy_document&quot; key to show inline policy document.</span>
<span class="sd">        Adds &quot;policy_arns&quot; key to list attached policies.</span>
<span class="sd">        Adds &quot;tags&quot; key to list function tags</span>
<span class="sd">        Returns None if no role is found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">role_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting IAM role with name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>
    <span class="n">iam</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Role&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">iam</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoSuchEntityException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to get IAM role for name </span><span class="si">{}</span><span class="s2"> with exception: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># get inline policies</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-policy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_role_policy</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">PolicyName</span><span class="o">=</span><span class="n">policy_name</span><span class="p">)</span>
        <span class="n">role</span><span class="p">[</span><span class="s2">&quot;policy_document&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;PolicyDocument&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="n">role</span><span class="p">[</span><span class="s2">&quot;policy_document&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># get attached policies</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_attached_role_policies</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">role</span><span class="p">[</span><span class="s2">&quot;policy_arns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">policy</span><span class="p">[</span><span class="s2">&quot;PolicyArn&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;AttachedPolicies&quot;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="n">role</span><span class="p">[</span><span class="s2">&quot;policy_arns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># get tags - reverse tags into dict</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_role_tags</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Tags&quot;</span><span class="p">]:</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">role</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span>

    <span class="k">return</span> <span class="n">role</span>


<span class="k">def</span> <span class="nf">get_role_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">role_arn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get function role name based on role_arn</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    role_arn : str</span>
<span class="sd">        Role arn</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Role name.</span>
<span class="sd">        Returns None if no role name is found for role arn.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">role_arn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">iam</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">)</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_roles</span><span class="p">()</span>
    <span class="n">role</span> <span class="o">=</span> <span class="p">[</span><span class="n">role</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">[</span><span class="s2">&quot;Roles&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">role</span><span class="p">[</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">role_arn</span><span class="p">]</span>
    <span class="n">role_name</span> <span class="o">=</span> <span class="n">role</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">role_name</span>


<span class="k">def</span> <span class="nf">delete_role</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">role_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove role from AWS resources</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    role_name : str</span>
<span class="sd">        Role name to delete</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">role_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`role_name` not defined in delete_role&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># make sure function exists</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">get_role</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">role_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;IAM role &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing IAM role &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>
    <span class="n">iam</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">)</span>

    <span class="c1"># need to remove inline policies first, if they exist</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-policy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">iam</span><span class="o">.</span><span class="n">delete_role_policy</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">PolicyName</span><span class="o">=</span><span class="n">policy_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># need to detach policies first</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_attached_role_policies</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;AttachedPolicies&quot;</span><span class="p">]:</span>
        <span class="n">iam</span><span class="o">.</span><span class="n">detach_role_policy</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">PolicyArn</span><span class="o">=</span><span class="n">policy</span><span class="p">[</span><span class="s2">&quot;PolicyArn&quot;</span><span class="p">])</span>

    <span class="n">iam</span><span class="o">.</span><span class="n">delete_role</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully removed IAM role &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># API Gateway</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">create_api</span><span class="p">(</span>
    <span class="n">session</span><span class="p">,</span> <span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;podpac-api&quot;</span><span class="p">,</span> <span class="n">api_description</span><span class="o">=</span><span class="s2">&quot;PODPAC API&quot;</span><span class="p">,</span> <span class="n">api_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_tags</span><span class="o">=</span><span class="p">{},</span> <span class="n">api_endpoint</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create API Gateway REST API</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    api_name : str</span>
<span class="sd">        API Name</span>
<span class="sd">    api_description : str, optional</span>
<span class="sd">        API Description. Defaults to &quot;PODPAC API&quot;</span>
<span class="sd">    api_version : str, optional</span>
<span class="sd">        API Version. Defaults to PODPAC version.</span>
<span class="sd">    api_tags : dict, optional</span>
<span class="sd">        API tags. Defaults to {}.</span>
<span class="sd">    api_endpoint : str, optional</span>
<span class="sd">        API endpoint. Defaults to &quot;eval&quot;.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        See :func:`podpac.managers.aws.get_api`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set version to podpac version, if None</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">get_api</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_name</span><span class="p">,</span> <span class="n">api_endpoint</span><span class="p">)</span>

    <span class="c1"># TODO: add checks to make sure api parameters match</span>
    <span class="k">if</span> <span class="n">api</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;resource&quot;</span> <span class="ow">in</span> <span class="n">api</span> <span class="ow">and</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;API &#39;</span><span class="si">{}</span><span class="s2">&#39; and API resource </span><span class="si">{}</span><span class="s2"> already exist. Using existing API ID and resource.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">api_name</span><span class="p">,</span> <span class="n">api_endpoint</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">api</span>

    <span class="c1"># add special podpac tags for billing id</span>
    <span class="n">api_tags</span><span class="p">[</span><span class="s2">&quot;_podpac_resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

    <span class="n">apigateway</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;apigateway&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">api</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating API gateway with name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_name</span><span class="p">))</span>

        <span class="c1"># set version default</span>
        <span class="k">if</span> <span class="n">api_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">api_version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">semver</span><span class="p">()</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">create_rest_api</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">api_name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">api_description</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">api_version</span><span class="p">,</span>
            <span class="n">binaryMediaTypes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*/*&quot;</span><span class="p">],</span>
            <span class="n">apiKeySource</span><span class="o">=</span><span class="s2">&quot;HEADER&quot;</span><span class="p">,</span>
            <span class="n">endpointConfiguration</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;REGIONAL&quot;</span><span class="p">]},</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">api_tags</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># create resource</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating API endpoint </span><span class="si">{}</span><span class="s2"> for API ID </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_endpoint</span><span class="p">,</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>

    <span class="c1"># get resources to get access to parentId (&quot;/&quot; path)</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>  <span class="c1"># TODO - make this based on path == &quot;/&quot; ?</span>

    <span class="c1"># create resource</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span><span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">parentId</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">pathPart</span><span class="o">=</span><span class="n">api_endpoint</span><span class="p">)</span>

    <span class="c1"># put method for resource</span>
    <span class="n">apigateway</span><span class="o">.</span><span class="n">put_method</span><span class="p">(</span>
        <span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">resourceId</span><span class="o">=</span><span class="n">resource</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">httpMethod</span><span class="o">=</span><span class="s2">&quot;ANY&quot;</span><span class="p">,</span>
        <span class="n">authorizationType</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>  <span class="c1"># TODO: support &quot;AWS_IAM&quot;</span>
        <span class="n">apiKeyRequired</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># TODO: create &quot;generate_key()&quot; method</span>
    <span class="p">)</span>

    <span class="c1"># save resource on api</span>
    <span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>

    <span class="k">return</span> <span class="n">api</span>


<span class="k">def</span> <span class="nf">get_api</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_name</span><span class="p">,</span> <span class="n">api_endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get API Gateway definition</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    api_name : str</span>
<span class="sd">        API Name</span>
<span class="sd">    api_endpoint : str, optional</span>
<span class="sd">        API endpoint path, defaults to returning the first endpoint it finds</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        (Returns output of Boto3 API Gateway creation</span>
<span class="sd">        Equivalent to https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/apigateway.html#APIGateway.Client.create_rest_api</span>
<span class="sd">        Contains extra key &quot;resource&quot; with output of of Boto3 API Resource. Set to None if API Resource ID is not found)</span>
<span class="sd">        Returns None if API Id is not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">api_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting API Gateway with name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_name</span><span class="p">))</span>
    <span class="n">apigateway</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;apigateway&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">get_rest_apis</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">apis</span> <span class="o">=</span> <span class="p">[</span><span class="n">api</span> <span class="k">for</span> <span class="n">api</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">api_name</span><span class="p">]</span>
        <span class="n">api_id</span> <span class="o">=</span> <span class="n">apis</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apis</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">api_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">api</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">get_rest_api</span><span class="p">(</span><span class="n">restApiId</span><span class="o">=</span><span class="n">api_id</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">api</span><span class="p">[</span><span class="s2">&quot;ResponseMetadata&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ParamValidationError</span><span class="p">,</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFoundException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to get API Gateway with name </span><span class="si">{}</span><span class="s2"> with exception: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># try to get stage</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">get_stages</span><span class="p">(</span><span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="n">api</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;stageName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># TODO: make this more specific?</span>
        <span class="k">pass</span>

    <span class="c1"># get resources</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">api_endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resources_filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">api_endpoint</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resources_filtered</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;pathPart&quot;</span> <span class="ow">in</span> <span class="n">r</span>
        <span class="p">]</span>  <span class="c1"># filter resources by ones with a &quot;pathPart&quot;</span>

    <span class="c1"># grab the first one, if it exists</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">resources_filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resources_filtered</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># save resource on api</span>
    <span class="n">api</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>

    <span class="k">return</span> <span class="n">api</span>


<span class="k">def</span> <span class="nf">deploy_api</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_id</span><span class="p">,</span> <span class="n">api_stage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deploy API gateway definition</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    api_id : str</span>
<span class="sd">        API ID. Generated during API creation or returned from :func:`podpac.manager.aws.get_api`</span>
<span class="sd">    api_stage : str</span>
<span class="sd">        API Stage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">api_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">api_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`api_id` and `api_stage` must be defined to deploy API&quot;</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deploying API Gateway with ID </span><span class="si">{}</span><span class="s2"> and stage </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_stage</span><span class="p">))</span>

    <span class="n">apigateway</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;apigateway&quot;</span><span class="p">)</span>
    <span class="n">apigateway</span><span class="o">.</span><span class="n">create_deployment</span><span class="p">(</span>
        <span class="n">restApiId</span><span class="o">=</span><span class="n">api_id</span><span class="p">,</span> <span class="n">stageName</span><span class="o">=</span><span class="n">api_stage</span><span class="p">,</span> <span class="n">stageDescription</span><span class="o">=</span><span class="s2">&quot;Deployment of PODPAC API&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;PODPAC API&quot;</span>
    <span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deployed API Gateway with ID </span><span class="si">{}</span><span class="s2"> and stage </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_stage</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">delete_api</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete API Gateway API</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    api_id : str</span>
<span class="sd">        API ID. Generated during API Creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">api_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`api_id` not defined in delete_api&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># make sure api exists</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">get_api</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;API Gateway &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_name</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing API Gateway with ID </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>

    <span class="n">apigateway</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;apigateway&quot;</span><span class="p">)</span>
    <span class="n">apigateway</span><span class="o">.</span><span class="n">delete_rest_api</span><span class="p">(</span><span class="n">restApiId</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully removed API Gateway with ID </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Budget</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>

<span class="c1"># Budget</span>
<span class="k">def</span> <span class="nf">create_budget</span><span class="p">(</span>
    <span class="n">session</span><span class="p">,</span>
    <span class="n">budget_amount</span><span class="p">,</span>
    <span class="n">budget_email</span><span class="p">,</span>
    <span class="n">budget_name</span><span class="o">=</span><span class="s2">&quot;podpac-resource-budget&quot;</span><span class="p">,</span>
    <span class="n">budget_currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span>
    <span class="n">budget_threshold</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span>
    <span class="n">budget_filter_tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_podpac_resource&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a budget for podpac AWS resources based on tags.</span>
<span class="sd">    By default, this creates a budget for all podpac created resources with the tag: {&quot;_podpac_resource&quot;: &quot;true&quot;}</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    budget_amount : int</span>
<span class="sd">        Budget amount</span>
<span class="sd">    budget_email : str</span>
<span class="sd">        Notification e-mail for budget alerts</span>
<span class="sd">    budget_name : str, optional</span>
<span class="sd">        Budget name</span>
<span class="sd">    budget_currency : str, optional</span>
<span class="sd">        Currency unit for budget. Defaults to &quot;USD&quot;.</span>
<span class="sd">        See https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/budgets.html#Budgets.Client.describe_budget</span>
<span class="sd">        for Unit types.</span>
<span class="sd">    budget_threshold : float, optional</span>
<span class="sd">        Percent of the budget at which an e-mail notification is sent.</span>
<span class="sd">    budget_filter_tags : dict, optional</span>
<span class="sd">        Create budget for specific set of resource tags.</span>
<span class="sd">        By default, the budget is created for all podpac created resources.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Returns Boto3 budget description</span>
<span class="sd">        Equivalent to https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/budgets.html#Budgets.Client.describe_budget</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># see if budget already exists</span>
    <span class="n">budget</span> <span class="o">=</span> <span class="n">get_budget</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">budget_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Budget &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. Using existing budget&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">budget_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">budget</span>

    <span class="c1"># format tags - this is a strange syntax discovered through inspection of boto3</span>
    <span class="n">filter_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user:</span><span class="si">{}</span><span class="s2">$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">budget_filter_tags</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="n">budgets</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;budgets&quot;</span><span class="p">)</span>

    <span class="c1"># create budget</span>
    <span class="n">budgets</span><span class="o">.</span><span class="n">create_budget</span><span class="p">(</span>
        <span class="n">AccountId</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get_account_id</span><span class="p">(),</span>
        <span class="n">Budget</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;BudgetName&quot;</span><span class="p">:</span> <span class="n">budget_name</span><span class="p">,</span>
            <span class="s2">&quot;BudgetLimit&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Amount&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">budget_amount</span><span class="p">),</span> <span class="s2">&quot;Unit&quot;</span><span class="p">:</span> <span class="n">budget_currency</span><span class="p">},</span>
            <span class="s2">&quot;CostFilters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;TagKeyValue&quot;</span><span class="p">:</span> <span class="n">filter_tags</span><span class="p">},</span>
            <span class="s2">&quot;CostTypes&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;IncludeTax&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;IncludeSubscription&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;UseBlended&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;IncludeRefund&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;IncludeCredit&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;IncludeUpfront&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;IncludeRecurring&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;IncludeOtherSubscription&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;IncludeSupport&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;IncludeDiscount&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;UseAmortized&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;TimeUnit&quot;</span><span class="p">:</span> <span class="s2">&quot;MONTHLY&quot;</span><span class="p">,</span>  <span class="c1"># only support monthly for now</span>
            <span class="s2">&quot;BudgetType&quot;</span><span class="p">:</span> <span class="s2">&quot;COST&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">NotificationsWithSubscribers</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;Notification&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;NotificationType&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTUAL&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ComparisonOperator&quot;</span><span class="p">:</span> <span class="s2">&quot;GREATER_THAN&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Threshold&quot;</span><span class="p">:</span> <span class="n">budget_threshold</span><span class="p">,</span>
                    <span class="s2">&quot;ThresholdType&quot;</span><span class="p">:</span> <span class="s2">&quot;PERCENTAGE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;NotificationState&quot;</span><span class="p">:</span> <span class="s2">&quot;ALARM&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;Subscribers&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;SubscriptionType&quot;</span><span class="p">:</span> <span class="s2">&quot;EMAIL&quot;</span><span class="p">,</span> <span class="s2">&quot;Address&quot;</span><span class="p">:</span> <span class="n">budget_email</span><span class="p">}],</span>
            <span class="p">}</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># get finalized budget</span>
    <span class="n">budget</span> <span class="o">=</span> <span class="n">get_budget</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">budget_name</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully created budget &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">budget_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">budget</span>


<span class="k">def</span> <span class="nf">get_budget</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">budget_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a budget by name</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    budget_name : str</span>
<span class="sd">        Budget name</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Returns Boto3 budget description</span>
<span class="sd">        Equivalent to https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/budgets.html#Budgets.Client.describe_budget</span>
<span class="sd">        Returns None if budget is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting budget with name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">budget_name</span><span class="p">))</span>
    <span class="n">budgets</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;budgets&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">budgets</span><span class="o">.</span><span class="n">describe_budget</span><span class="p">(</span><span class="n">AccountId</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get_account_id</span><span class="p">(),</span> <span class="n">BudgetName</span><span class="o">=</span><span class="n">budget_name</span><span class="p">)</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Budget&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ParamValidationError</span><span class="p">,</span> <span class="n">budgets</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFoundException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to get budget with name </span><span class="si">{}</span><span class="s2"> with exception: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">budget_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">budget</span>


<span class="k">def</span> <span class="nf">delete_budget</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">budget_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete a budget by name</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    budget_name : str</span>
<span class="sd">        Budget name</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">budgets</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;budgets&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_budget</span><span class="p">(</span><span class="n">AccountId</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get_account_id</span><span class="p">(),</span> <span class="n">BudgetName</span><span class="o">=</span><span class="n">budget_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">apigateway</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFoundException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully removed budget with name &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">budget_name</span><span class="p">))</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># Cloudwatch Logs</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">get_logs</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">log_group_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get logs from cloudwatch from specific log groups</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    session : :class:`Session`</span>
<span class="sd">        AWS Boto3 Session. See :class:`Session` for creation.</span>
<span class="sd">    log_group_name : str</span>
<span class="sd">        Log group name</span>
<span class="sd">    limit : int, optional</span>
<span class="sd">        Limit logs to the most recent N logs</span>
<span class="sd">    start : str, optional</span>
<span class="sd">        Datetime string. Must work as input to np.datetime64 (i.e np.datetime64(start))</span>
<span class="sd">        Defaults to 1 hour prior to ``end``.</span>
<span class="sd">    end : str, optional</span>
<span class="sd">        Datetime string. Must work as input to np.datetime64 (i.e np.datetime64(end))</span>
<span class="sd">        Defaults to now.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        list of log events</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># default is now</span>
    <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="c1"># default is 1 hour prior to now</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="c1"># convert to float and add precision for comparison with AWS response</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="c1"># get client</span>
    <span class="n">cloudwatchlogs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span>  <span class="c1"># cloudwatch logs</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">log_streams</span> <span class="o">=</span> <span class="n">cloudwatchlogs</span><span class="o">.</span><span class="n">describe_log_streams</span><span class="p">(</span>
            <span class="n">logGroupName</span><span class="o">=</span><span class="n">log_group_name</span><span class="p">,</span> <span class="n">orderBy</span><span class="o">=</span><span class="s2">&quot;LastEventTime&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">cloudwatchlogs</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ResourceNotFoundException</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No log streams found for log group name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_group_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">streams</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">log_streams</span><span class="p">[</span><span class="s2">&quot;logStreams&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;firstEventTimestamp&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;lastEventTimestamp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">cloudwatchlogs</span><span class="o">.</span><span class="n">get_log_events</span><span class="p">(</span>
            <span class="n">logGroupName</span><span class="o">=</span><span class="n">log_group_name</span><span class="p">,</span>
            <span class="n">logStreamName</span><span class="o">=</span><span class="n">stream</span><span class="p">[</span><span class="s2">&quot;logStreamName&quot;</span><span class="p">],</span>
            <span class="n">startTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span>
            <span class="n">endTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logs</span> <span class="o">+=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>

    <span class="c1"># sort logs</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>

    <span class="c1"># take only the last &quot;limit&quot;</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">logs</span><span class="p">[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span>

    <span class="c1"># add time easier to read</span>
    <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
        <span class="n">log</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span> <span class="n">log</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">1000</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">logs</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, Creare

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>